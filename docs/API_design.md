# ğŸ“šAPI è¨­è¨ˆæ›¸

ã‚ã‚“ ğŸ¾ ã¿ã£ã—ã‚‡ã‚“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã€è¨­å®šãƒšãƒ¼ã‚¸ã€æ¯æ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³å®Ÿæ–½è¨˜éŒ²ã€åçœæ–‡ã€çŠ¬ã®ã²ã¨ã“ã¨å±¥æ­´ã€æ•£æ­©ã®æˆåŠŸ/å¤±æ•—ã€Stripe æ±ºæ¸ˆã®ç®¡ç†ã‚’ã™ã‚‹ãŸã‚ã® RESTful API ã§ã™ã€‚

## 1. API æ¦‚è¦

- **ãƒ™ãƒ¼ã‚¹ URL**ï¼š`http://localhost:8000/api`
- **ã‚¹ã‚­ãƒ¼ãƒ **ï¼š`HTTP`
- **èªè¨¼**ï¼šFirebase èªè¨¼
- **ãƒ‡ãƒ¼ã‚¿å½¢å¼**ï¼šJSON
- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**ï¼šv1

---

## 2. ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

æœ¬ã‚¢ãƒ—ãƒªã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨è¨­å®šï¼ˆcare_settingsï¼‰ã¯ 1 å¯¾ 1 ã§é–¢é€£ã—ã¦ãŠã‚Šã€`care_logs` ã‚„ `reflection_notes` ã¯ãã®è¨­å®šã«å¯¾ã—ã¦è¨˜éŒ²ã•ã‚Œã‚‹ã€‚`user_id` ã¨ `care_setting_id` ã¯åˆ¥ã® IDã€‚

## 2.1 ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:**Â `/api/users/`
- **ãƒ¡ã‚½ãƒƒãƒ‰:**Â `GET`,Â `POST`
- **èª¬æ˜:**Â Firebase UID + UUID ç®¡ç†ã€ãƒ—ãƒ©ãƒ³ç®¡ç†ï¼ˆcurrent_planï¼‰ä»˜ã

### 2.1-1 æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²

- POST`/api/users`
- Firebase èªè¨¼å¾Œã«ã‚¢ãƒ—ãƒªç‹¬è‡ª DB ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹

**ğŸ” èªè¨¼**

- Firebase ãƒˆãƒ¼ã‚¯ãƒ³ã§ UID ã‚’å–å¾—å¾Œã«å‘¼ã³å‡ºã—ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã§ UID ã‚’å—ã‘å–ã‚‹æƒ³å®šï¼‰

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹:**

```json
{
  "firebase_uid": "A1b2C3d4E5F6G7",
  "email": "user@example.com",
  "current_plan": "free",
  "is_verified": true
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "id": "1fc99ee4-87e6-4a58-bbeb-a8f122b4567d",
  "firebase_uid": "A1b2C3d4E5F6G7",
  "email": "user@example.com",
  "current_plan": "free",
  "is_verified": true,
  "created_at": "2025-06-14T08:00:00+09:00",
  "updated_at": "2025-06-14T08:00:00+09:00"
}
```

### 2.1-2 ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—

- GET`/api/users/me`
- Firebase ã® ID ãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚ˆã‚Šã€å¯¾è±¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç‰¹å®š

**ğŸ” èªè¨¼**

- Authorization ãƒ˜ãƒƒãƒ€ãƒ¼ã« Firebase ID ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦

```json
Authorization: Bearer <Firebase_ID_Token>
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "id": "1fc99ee4-87e6-4a58-bbeb-a8f122b4567d",
  "firebase_uid": "A1b2C3d4E5F6G7",
  "email": "user@example.com",
  "current_plan": "premium",
  "is_verified": true,
  "created_at": "2025-06-14T08:00:00+09:00",
  "updated_at": "2025-06-14T09:00:00+09:00"
}
```

ç¾åœ¨ã€ãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼ˆã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç›´æ¥ PATCH ã™ã‚‹ã®ã§ã¯ãªãã€Stripe Webhook å‡¦ç†ã§è‡ªå‹•æ›´æ–°ã‚’è¡Œã†è¨­è¨ˆã€‚

---

## 2.2 åˆå›è¨­å®šãƒšãƒ¼ã‚¸

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:**Â `/api/care_settings/`
- **ãƒ¡ã‚½ãƒƒãƒ‰:**Â `GET`,Â `POST`
- **èª¬æ˜:**
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ãŠä¸–è©±è¨­å®šæƒ…å ±ã‚’ç®¡ç†
  - è¦ªãƒ»å­ã©ã‚‚ãƒ»çŠ¬ã®åå‰ã€é–‹å§‹ãƒ»çµ‚äº†æœŸé–“ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ™‚é–“å¸¯ã€PIN ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã©ã‚’ä¿å­˜

### 2.2-1 æ–°è¦ç™»éŒ²ï¼ˆåˆå›è¨­å®šï¼‰

- POST`/api/care_settings`
- Firebase èªè¨¼å¾Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID ã‚’è‡ªå‹•ã§ç´ã¥ã‘ã¦ç™»éŒ²

**ğŸ” èªè¨¼**

```
Authorization: Bearer <Firebase_ID_Token>
```

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹:**

```json
{
  "parent_name": "ã¾ã‚†ã¿ãƒãƒ",
  "child_name": "ã•ãã¡ã‚ƒã‚“",
  "dog_name": "ã“ã‚ã‚“",
  "care_start_date": "2025-06-14",
  "care_end_date": "2025-07-14",
  "morning_meal_time": "07:00",
  "night_meal_time": "18:00",
  "walk_time": "17:00",ã€€ã€€
  "care_password": "1234",
  "care_clear_status": "not_cleared"
}
â€» `user_id` ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ Firebase ã®èªè¨¼æƒ…å ±ã‹ã‚‰è‡ªå‹•ã§ç´ã¥ã‘
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "id": 5,
  "user_id": "1fc99ee4-87e6-4a58-bbeb-a8f122b4567d",
  "parent_name": "ã¾ã‚†ã¿ãƒãƒ",
  "child_name": "ã•ãã¡ã‚ƒã‚“",
  "dog_name": "ã“ã‚ã‚“",
  "care_start_date": "2025-06-14",
  "care_end_date": "2025-07-14",
  "morning_meal_time": "07:00:00",
  "night_meal_time": "18:00:00",
  "walk_time": "17:00:00",
  "care_password": "1234",
  "care_clear_status": "not_cleared",
  "created_at": "2025-06-14T08:00:00+09:00",
  "updated_at": "2025-06-14T09:00:00+09:00"
}
```

### 2.2-2 è‡ªåˆ†ã®è¨­å®šæƒ…å ±ã‚’å–å¾—

- GET`/api/care_settings/me`
- Firebase ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ç‰¹å®šã—ã€ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® care_setting ã‚’ 1 ä»¶å–å¾—

**ğŸ” èªè¨¼**

```
Authorization: Bearer <Firebase_ID_Token>
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "id": 5,
  "parent_name": "ã¾ã‚†ã¿ãƒãƒ",
  "child_name": "ã•ãã¡ã‚ƒã‚“",
  "dog_name": "ã“ã‚ã‚“",
  "care_start_date": "2025-06-14",
  "care_end_date": "2025-07-14",
  "morning_meal_time": "07:00:00",
  "night_meal_time": "18:00:00",
  "walk_time": "17:00:00"
}
```

### 2.2-3 ç®¡ç†ç”»é¢ã‚¢ã‚¯ã‚»ã‚¹ç”¨ PIN èªè¨¼

- POST`/api/care_settings/verify_pin`
- åˆå›ã® `/api/care_settings` ç™»éŒ²æ™‚ã«ä¿å­˜ã•ã‚Œã‚‹ `"care_password"` ã‚’ä½¿ã£ã¦ç…§åˆ

**ğŸ” èªè¨¼**

```
Authorization: Bearer <Firebase_ID_Token>
```

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹:**

```json
{
  "input_password": "1234"
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "verified": true
}
```

â€» PIN ãŒä¸€è‡´ã—ãªã„å ´åˆï¼š

```json
{
  "verified": false
}
```

---

## 2.3 ãŠä¸–è©±è¨˜éŒ²

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:**Â `/api/care_logs/`
- **ãƒ¡ã‚½ãƒƒãƒ‰:**Â `GET`,Â `POST` ,`PATCH`
- **èª¬æ˜:**
  - æ¯æ—¥ã®è¨˜éŒ²ï¼ˆæœã”ã¯ã‚“ãƒ»å¤œã”ã¯ã‚“ãƒ»æ•£æ­©ã®å®Ÿæ–½çŠ¶æ³ãªã©ï¼‰ã‚’è¨˜éŒ²ã™ã‚‹
  - 1 æ—¥ã”ã¨ã« 1 ä»¶ã®ãƒ¬ã‚³ãƒ¼ãƒ‰
  - `care_setting_id` ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§ Firebase èªè¨¼ã‹ã‚‰è‡ªå‹•ç´ã¥ã‘

### 2.3-1 æœ¬æ—¥ã®è¨˜éŒ²ã‚’å–å¾—ï¼ˆä¿è­·è€…ç”¨ï¼‰

- GET`/api/care_logs/today`
- æŒ‡å®šæ—¥ã®è¨˜éŒ²ã‚’å–å¾—ã—ã€ãƒŸãƒƒã‚·ãƒ§ãƒ³é”æˆçŠ¶æ³ã‚’ç¢ºèª

**ğŸ” èªè¨¼**

```
Authorization: Bearer <Firebase_ID_Token>
```

**ğŸ“¥ ã‚¯ã‚¨ãƒªä¾‹:**

```
/api/care_logs/today?care_setting_id=5&date=2025-06-14

```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "care_log_id": 21,
  "fed_morning": true,
  "fed_night": false,
  "walked": true
}
```

âœ… â€» è¨˜éŒ²ãŒç„¡ã„å ´åˆ

```json
{
  "care_log_id": null,
  "fed_morning": false,
  "fed_night": false,
  "walked": false
}
```

### 2.3-2 æ—¥ä»˜æŒ‡å®šã§è¨˜éŒ²ã‚’å–å¾—ï¼ˆæŒ¯ã‚Šè¿”ã‚Šç”¨ï¼‰

- **GET** `/api/care_logs/by_date`
- ä»»æ„ã®æ—¥ä»˜ã®è¨˜éŒ²ã‚’å–å¾—

**ğŸ” èªè¨¼**

```
Authorization: Bearer <Firebase_ID_Token>
```

**ğŸ“¥ ã‚¯ã‚¨ãƒªä¾‹:**

```
/api/care_logs/by_date?care_setting_id=5&date=2025-07-13
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "care_log_id": 19,
  "fed_morning": true,
  "fed_night": true,
  "walked": false
}
```

âœ… è¨˜éŒ²ãŒç„¡ã„å ´åˆ

```json
{
  "care_log_id": null,
  "fed_morning": false,
  "fed_night": false,
  "walked": false
}
```

### 2.3-3 æ–°è¦è¨˜éŒ²ï¼ˆãƒŸãƒƒã‚·ãƒ§ãƒ³é”æˆæ™‚ï¼‰

- POST`/api/care_logs`
- 1 æ—¥ 1 ä»¶ã€‚ã™ã§ã«è¨˜éŒ²ãŒã‚ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã€‚

**ğŸ” èªè¨¼**

```
Authorization: Bearer <Firebase_ID_Token>
```

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹:**

```json
{
  "date": "2025-07-14",
  "fed_morning": true,
  "fed_night": false,
  "walk_result": true,
  "walk_total_distance_m": 1023
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "id": 21,
  "care_setting_id": 5,
  "date": "2025-07-14",
  "fed_morning": true,
  "fed_night": false,
  "walk_result": true,
  "walk_total_distance_m": 1023,
  "created_at": "2025-07-14T09:15:00+09:00"
```

âœ… â€» æ—¢ã«åŒã˜æ—¥ä»˜ãŒå­˜åœ¨ã™ã‚‹å ´åˆ

```json
{
  "detail": "ã“ã®æ—¥ä»˜ã®è¨˜éŒ²ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚PATCHã§æ›´æ–°ã—ã¦ãã ã•ã„ã€‚"
}
```

### 2.3-4 æ—¢å­˜ãƒ­ã‚°ã®æ›´æ–°ï¼ˆå¾Œã‹ã‚‰å¤œã”ã¯ã‚“ã‚’æŠ¼ã—ãŸãªã©ï¼‰

- PATCH`/api/care_logs/{id}`
- æŒ‡å®š ID ã®è¨˜éŒ²ã‚’éƒ¨åˆ†æ›´æ–°

**ğŸ” èªè¨¼**

```
Authorization: Bearer <Firebase_ID_Token>
```

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹(å¤œã”ã¯ã‚“ã‚’å¾Œã‹ã‚‰è¿½åŠ ):**

```json
{
  "fed_night": true
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "id": 21,
  "care_setting_id": 5,
  "date": "2025-07-14",
  "fed_morning": true,
  "fed_night": true,
  "walk_result": true,
  "walk_total_distance_m": 1200,
  "created_at": "2025-07-14T09:15:00+09:00"
}
```

### 2.3-5 å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆç®¡ç†ç”»é¢ï¼‰

- **GET** `/api/care_logs/list`
- æŒ‡å®š`care_setting_id`ã®å…¨è¨˜éŒ²ã‚’å–å¾—

**ğŸ” èªè¨¼**

```
Authorization: Bearer <Firebase_ID_Token>
```

**ğŸ“¥ ã‚¯ã‚¨ãƒªä¾‹:**

```
/api/care_logs/list?care_setting_id=5
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "care_logs": [
    {
      "id": 1,
      "date": "2025-07-10",
      "walk_result": true,
      "care_setting_id": 5
    },
    {
      "id": 2,
      "date": "2025-07-11",
      "walk_result": false,
      "care_setting_id": 5
    }
  ]
}
```

---

## 2.4 åçœæ–‡

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:**Â `/api/reflection_notes/`
- **ãƒ¡ã‚½ãƒƒãƒ‰:**Â `GET`,Â `POST` ,`PATCH`
- **èª¬æ˜:**Â  åçœæ–‡ã¯å­ä¾›ãŒæ›¸ãï¼ä¿è­·è€…ã®æ‰¿èªãƒ•ãƒ©ã‚°ä»˜ã
  - å­ã©ã‚‚ãŒåçœæ–‡ã‚’æ›¸ã â†’ ä¿è­·è€…ãŒç¢ºèªï¼†æ‰¿èª
  - 1 äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¤‡æ•°æ›¸ãã‚±ãƒ¼ã‚¹ã‚’æƒ³å®š
  - `care_setting_id` ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§è‡ªå‹•è§£æ±º

### 2.4-1 åçœæ–‡ä¸€è¦§ã‚’å–å¾—ï¼ˆä¿è­·è€…ç”¨ï¼‰

- GET`/api/reflection_notes`
- ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆä¿è­·è€…ï¼‰ã® `care_setting_id` ã«ç´ã¥ãå…¨ã¦ã®åçœæ–‡ã‚’è¿”å´

**ğŸ” èªè¨¼**

```
Authorization: Bearer <Firebase_ID_Token>
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
[
  {
    "id": 1,
    "care_setting_id": 5,
    "content": "ã­ã¼ã†ã—ã¦ã‚ã•ã”ã¯ã‚“ã‚’ã‚ã™ã‚Œã¾ã—ãŸã€‚ã“ã‚ã‚“ã€ã”ã‚ã‚“ã­ã€‚",
    "approved_by_parent": false,
    "created_at": "2025-06-14T10:00:00+09:00",
    "updated_at": "2025-06-14T10:00:00+09:00"
  },
  {
    "id": 2,
    "care_setting_id": 5,
    "content": "ã“ã‚ã‚“ã®ã•ã‚“ã½ã‚’ã‚ã™ã‚Œã¦ã—ã¾ã£ãŸã€‚ã¤ãã¯ãã‚’ã¤ã‘ã‚‹ï¼",
    "approved_by_parent": true,
    "created_at": "2025-06-15T09:45:00+09:00",
    "updated_at": "2025-06-15T10:00:00+09:00"
  }
]
```

### 2.4-2 å­ã©ã‚‚ãŒåçœæ–‡ã‚’æ–°è¦æŠ•ç¨¿

- POST`/api/reflection_notes`
- ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® `care_setting_id` ã«è‡ªå‹•ç´ã¥ã‘ã¦æ–°è¦ä¿å­˜

**ğŸ” èªè¨¼**

```
Authorization: Bearer <Firebase_ID_Token>
```

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹:**

```json
{
  "content": "ã“ã‚ã‚“ã®ã•ã‚“ã½ã‚’ã‚ã™ã‚Œã¦ã—ã¾ã£ãŸã€‚ã¤ãã¯ãã‚’ã¤ã‘ã‚‹ï¼"
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "id": 3,
  "care_setting_id": 5,
  "content": "ã“ã‚ã‚“ã®ã•ã‚“ã½ã‚’ã‚ã™ã‚Œã¦ã—ã¾ã£ãŸã€‚ã¤ãã¯ãã‚’ã¤ã‘ã‚‹ï¼",
  "approved_by_parent": false,
  "created_at": "2025-06-16T09:00:00+09:00",
  "updated_at": "2025-06-16T09:00:00+09:00"
}
```

âœ… â€» ã‚µãƒ¼ãƒãƒ¼å´ã§

- care_setting_id è‡ªå‹•æŒ¿å…¥
- approved_by_parent ã¯åˆæœŸå€¤ false å›ºå®š

### 2.4-3 ä¿è­·è€…ãŒåçœæ–‡ã‚’æ‰¿èª

- PATCH`/api/reflection_notes/{note_id}`
- ç‰¹å®šã®åçœæ–‡ã® `approved_by_parent` ã‚’æ›´æ–°

**ğŸ” èªè¨¼**

```
Authorization: Bearer <Firebase_ID_Token>
```

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹:**

```json
{
  "approved_by_parent": true
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "id": 3,
  "care_setting_id": 5,
  "content": "ã“ã‚ã‚“ã®ã•ã‚“ã½ã‚’ã‚ã™ã‚Œã¦ã—ã¾ã£ãŸã€‚ã¤ãã¯ãã‚’ã¤ã‘ã‚‹ï¼",
  "approved_by_parent": true,
  "created_at": "2025-06-16T09:00:00+09:00",
  "updated_at": "2025-06-16T10:00:00+09:00"
}
```

---

## 2.5 çŠ¬ã®ã²ã¨ã“ã¨å±¥æ­´

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:**Â `/api/message_logs/`
- **ãƒ¡ã‚½ãƒƒãƒ‰:**Â `POST`
- **èª¬æ˜:**Â  çŠ¬ãŒã²ã¨ã“ã¨ã‚’ã—ã‚ƒã¹ã‚‹ã€‚æœ‰æ–™ä¼šå“¡ã¯ LLM ãƒ™ãƒ¼ã‚¹ã€ç„¡æ–™ä¼šå“¡ã¯æ±ºã¾ã£ãŸã‚»ãƒªãƒ•
  - ãƒ—ãƒ¬ãƒŸã‚¢ãƒ åˆ¤å®šï¼š`users.current_plan === 'premium'` ã§åˆ‡ã‚Šåˆ†ã‘ã‚‹
  - DB ã«ã¯ä¿å­˜ã›ãšã€ãã®å ´ã§ç”Ÿæˆã—ã¦ãƒ•ãƒ­ãƒ³ãƒˆã«è¿”ã™

### 2.5-1 çŠ¬ã®ã²ã¨ã“ã¨ç”Ÿæˆ API

- POST`/api/message_logs/generate`
- ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸã¨ããªã©ã«å‘¼ã³å‡ºã—ã€ãã®å ´ã§ç”Ÿæˆã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã«è¿”ã™

**ğŸ” èªè¨¼**

```
Authorization: Bearer <Firebase_ID_Token>
```

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ï¼ˆç©ºé€ä¿¡ OKï¼‰:**

```json
{}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹ï¼ˆå›ºå®š or LLM ãƒ™ãƒ¼ã‚¹ã‚’åˆ¤å®šã—ã¦è¿”å´ï¼‰:**

âœ… ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã®å ´åˆï¼ˆLLM ç”Ÿæˆä¾‹ï¼‰

```json
{
  "message": "ã¯ã¿ãŒããŸã„ã›ã¤ã ã‚ã‚“"
}
```

âœ… ç„¡æ–™ãƒ—ãƒ©ãƒ³ã®å ´åˆï¼ˆå›ºå®šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¾‹ï¼‰

```json
{
  "message": "ã‚ã‚“ï¼"
}
```

---

## 2.6 Stripe æ±ºæ¸ˆã®ãƒ­ã‚°ç®¡ç†

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:**Â `/api/payment/`
- **ãƒ¡ã‚½ãƒƒãƒ‰:**Â `POST`
- **èª¬æ˜:**
  - Stripe Checkout ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆ
  - æ±ºæ¸ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
  - Webhook çµŒç”±ã®æ”¯æ‰•ã„è¨˜éŒ²ã¯ webhook_events çµŒç”±ã§å†…éƒ¨å‡¦ç†ã™ã‚‹è¨­è¨ˆã®ãŸã‚ã€ã“ã“ã§ç›´æ¥å—ã‘å–ã‚‰ãªã„

### 2.6-1 ãƒ—ãƒ¬ãƒŸã‚¢ãƒ è³¼å…¥ã‚’é–‹å§‹ã™ã‚‹ï¼ˆStripe Checkout ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼‰

- POST`/api/payment/checkout-session`
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã€Œè³¼å…¥ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã«å‘¼ã°ã‚Œã¦ã€Stripe Checkout ã®æ±ºæ¸ˆãƒšãƒ¼ã‚¸ URL ã‚’è¿”ã™

**ğŸ” èªè¨¼**

```
Authorization: Bearer <Firebase_ID_Token>
```

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé€ä¿¡ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã¯ç©ºï¼‰:**

```json
{}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹ï¼ˆæˆåŠŸæ™‚ï¼‰:**

```json
{
  "url": "https://checkout.stripe.com/pay/cs_test_abc123"
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹ï¼ˆã™ã§ã«ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã®å ´åˆï¼‰**

```json
{
  "detail": "ã™ã§ã«ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã§ã™ã€‚å†åº¦ã®è³¼å…¥ã¯ä¸è¦ã§ã™ã€‚"
}
```

- HTTP 400

**ã‚µãƒ¼ãƒãƒ¼å‡¦ç†ï¼š**

1.  Firebase ID ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰`firebase_uid`ã‚’ç‰¹å®š
2.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ©ãƒ³ã‚’ DB ã‹ã‚‰ç¢ºèª
3.  ã™ã§ã«ã€Œpremiumã€ãªã‚‰ã‚¨ãƒ©ãƒ¼è¿”å´ï¼ˆè³¼å…¥é˜²æ­¢ï¼‰
4.  Stripe Checkout ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
5.  ã‚»ãƒƒã‚·ãƒ§ãƒ³ URL ã‚’è¿”å´

---

## 2.7 Stripe ã‹ã‚‰ã® Webhook ã‚¤ãƒ™ãƒ³ãƒˆã®è¨˜éŒ²

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:**Â `/api/webhook_events/`
- **ãƒ¡ã‚½ãƒƒãƒ‰:**Â `POST`
- **èª¬æ˜:**
  - Stripe ã‹ã‚‰é€ã‚‰ã‚Œã¦ãã‚‹ Webhook ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£æŸ»ç”¨ã«**å¿…ãšè¨˜éŒ²**
  - æˆåŠŸãƒ»å¤±æ•—å•ã‚ãšå…¨ã¦ãƒ­ã‚°ä¿å­˜
  - å‡¦ç†æ¸ˆã¿ã¯`processed=True`ã€ã‚¨ãƒ©ãƒ¼æ™‚ã¯`error_message`ã‚’è¨˜éŒ²

### 2.7-1 Stripe Webhook ã‚¤ãƒ™ãƒ³ãƒˆã®å—ä¿¡å‡¦ç†

- POST`/api/webhook_events/`
- Stripe ã® Webhook ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«è¨­å®š
- Stripe å´ãŒè‡ªå‹•é€ä¿¡ã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡ã—ã¦ä¿å­˜

**ğŸ” èªè¨¼**

- Stripe ãŒç›´æ¥å‘¼ã³å‡ºã™ãŸã‚ã€API ã‚­ãƒ¼ãªã©ã®èªè¨¼ã¯ãªã—

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ï¼ˆStripe ãŒè‡ªå‹•é€ä¿¡ ä¾‹ï¼‰:**

```json
{
  "id": "evt_1xyz456",
  "type": "checkout.session.completed",
  "data": {
    "object": {
      "id": "cs_test_abc123",
      "payment_intent": "pi_1ABC123",
      "amount_total": 300,
      "currency": "jpy",
      "customer_email": "user@example.com",
      "status": "paid",
      "metadata": {
        "firebase_uid": "A1b2C3d4E5F6G7"
      }
    }
  }
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "message": "Webhook eventã‚’ä¿å­˜ã—ã¾ã—ãŸ"
}
```

**ã‚µãƒ¼ãƒãƒ¼å´ã®å‡¦ç†æ¦‚è¦ï¼š**

1. JSON ãƒœãƒ‡ã‚£ã‚’å—ä¿¡ã—ã¦ãƒ‘ãƒ¼ã‚¹
2. `webhook_events` ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼š

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å               | å€¤                                  |
| -------------------------- | ----------------------------------- |
| `id`                       | `evt_1xyz456`ï¼ˆStripe ã‚¤ãƒ™ãƒ³ãƒˆ IDï¼‰ |
| `event_type`               | `checkout.session.completed`        |
| `stripe_session_id`        | `cs_test_abc123`                    |
| `stripe_payment_intent_id` | `pi_1ABC123`                        |
| `customer_email`           | `user@example.com`                  |
| `amount`                   | 300                                 |
| `currency`                 | `"jpy"`                             |
| `payment_status`           | `"paid"`                            |
| `payload`                  | å—ä¿¡ã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆå…¨æ–‡ï¼ˆJSONï¼‰      |
| `processed`                | åˆæœŸå€¤ã¯`False`                     |
| `error_message`            | ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°è¨˜éŒ²ã€æˆåŠŸæ™‚ã¯ null   |

3.  `checkout.session.completed`ã®å ´åˆã¯å³åº§ã«å‡¦ç†ã‚’è©¦ã¿ã¦ã€payment ç™»éŒ²ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼`current_plan`ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰

### 2.7-2 Webhook ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã¾ã¨ã‚ã¦å‡¦ç†ï¼ˆå†…éƒ¨ç®¡ç†ç”¨ï¼‰

- POST `/api/webhook_events/process`
- Stripe ã‹ã‚‰ã¯å‘¼ã°ã‚Œãšã€ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨ or ç®¡ç†ç”¨ãƒãƒƒãƒç”¨
- DB ã«æºœã¾ã£ãŸæœªå‡¦ç†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã¾ã¨ã‚ã¦å‡¦ç†
- èª¬æ˜:
  - `processed=False`ã‹ã¤`event_type=checkout.session.completed`ãªãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
  - 1 ä»¶ãšã¤ `payment` ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç™»éŒ²
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®`current_plan`ã‚’`premium`ã«æ›´æ–°
  - æˆåŠŸã—ãŸã‚‚ã®ã¯`processed=True`ã«æ›´æ–°
  - ã‚¨ãƒ©ãƒ¼ã¯`error_message`ã‚’è¨˜éŒ²ã—ã¦æ¬¡ã¸

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹(**ç®¡ç†ç”¨ãªã®ã§é€šå¸¸ç©ºé€ä¿¡**)**

```json
{}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹ï¼ˆæˆåŠŸæ™‚ï¼‰**

```json
{
  "message": "3 ä»¶ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã—ã¦paymentãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜ã—ã¾ã—ãŸ"
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹ï¼ˆæœªå‡¦ç†ãŒãªã„å ´åˆï¼‰**

```json
{
  "message": "æœªå‡¦ç†ã®Webhookã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“"
}
```

**ã‚µãƒ¼ãƒãƒ¼å‡¦ç†ï¼š**

1.  æœªå‡¦ç†ã‚¤ãƒ™ãƒ³ãƒˆã‚’å…¨ä»¶å–å¾—
2.  1 ä»¶ãšã¤ï¼š

- payment ãƒ†ãƒ¼ãƒ–ãƒ«ã« INSERT
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ current_plan ã‚’ premium ã«æ›´æ–°
- æˆåŠŸ â†’processed ã‚’ True
- å¤±æ•— â†’error_message ã‚’è¨˜éŒ²

---

## 3. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰

- `200 OK`: ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»æ›´æ–°æˆåŠŸ
- `201 Created`: æ–°è¦ä½œæˆæˆåŠŸ
- `400 Bad Request`: ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸æ­£
- `401 Unauthorized`: èªè¨¼ã‚¨ãƒ©ãƒ¼
- `403 Forbidden`: æ¨©é™ã‚¨ãƒ©ãƒ¼
- `404 Not Found`: ãƒªã‚½ãƒ¼ã‚¹ãªã—
- `500 Internal Server Error`: ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼
