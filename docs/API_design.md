# ğŸ“šAPI è¨­è¨ˆæ›¸

ã‚ã‚“ ğŸ¾ ã¿ã£ã—ã‚‡ã‚“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã€è¨­å®šãƒšãƒ¼ã‚¸ã€æ¯æ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³å®Ÿæ–½è¨˜éŒ²ã€åçœæ–‡ã€çŠ¬ã®ã²ã¨ã“ã¨å±¥æ­´ã€æ•£æ­©ã®æˆåŠŸ/å¤±æ•—ã€Stripe æ±ºæ¸ˆã®ç®¡ç†ã‚’ã™ã‚‹ãŸã‚ã® RESTful API ã§ã™ã€‚

## 1. API æ¦‚è¦

- **ãƒ™ãƒ¼ã‚¹ URL**ï¼š`http://localhost:8000/api`
- **ã‚¹ã‚­ãƒ¼ãƒ **ï¼š`HTTP`
- **èªè¨¼**ï¼šFirebase èªè¨¼
- **ãƒ‡ãƒ¼ã‚¿å½¢å¼**ï¼šJSON
- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**ï¼šv1

---

## 2. ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

æœ¬ã‚¢ãƒ—ãƒªã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨è¨­å®šï¼ˆcare_settingsï¼‰ã¯ 1 å¯¾ 1 ã§é–¢é€£ã—ã¦ãŠã‚Šã€`care_logs` ã‚„ `reflection_notes` ã¯ãã®è¨­å®šã«å¯¾ã—ã¦è¨˜éŒ²ã•ã‚Œã‚‹ã€‚`user_id` ã¨ `care_setting_id` ã¯åˆ¥ã® IDã€‚

## 2.1 ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:**Â `/api/users/`
- **ãƒ¡ã‚½ãƒƒãƒ‰:**Â `GET`,Â `POST` ,`PATCH`
- **èª¬æ˜:**Â Firebase UID + UUID ç®¡ç†ã€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ•ãƒ©ã‚°ï¼ˆcurrent_planï¼‰ä»˜ã

### 2.1-1 æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²

- POST`/api/users`
- Firebase èªè¨¼å¾Œã«ã‚¢ãƒ—ãƒªç‹¬è‡ª DB ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹:**

```json
{
  "firebase_uid": "A1b2C3d4E5F6G7",
  "email": "user@example.com",
  "current_plan": "free",
  "is_verified": true
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "id": "1fc99ee4-87e6-4a58-bbeb-a8f122b4567d",
  "firebase_uid": "A1b2C3d4E5F6G7",
  "email": "user@example.com",
  "current_plan": "free",
  "is_verified": true,
  "created_at": "2025-06-14T08:00:00+09:00",ã€€ã€€- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ—¥
  "updated_at": "2025-06-14T08:00:00+09:00"ã€€ã€€ - ãƒ—ãƒ©ãƒ³æ›´æ–°ï¼ˆä½•ã‹æ›´æ–°ã•ã‚ŒãŸæ™‚ï¼‰
}
```

### 2.1-2 ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—

- GET`/api/users/me`
- Firebase ã® ID ãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚ˆã‚Šã€å¯¾è±¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç‰¹å®š

**ğŸ” èªè¨¼**

- Authorization ãƒ˜ãƒƒãƒ€ãƒ¼ã« Firebase ID ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦

```json
Authorization: Bearer <Firebase_ID_Token>
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "id": "1fc99ee4-87e6-4a58-bbeb-a8f122b4567d",
  "email": "user@example.com",
  "current_plan": "premium",
  "is_verified": true,
  "created_at": "2025-06-14T08:00:00+09:00",
  "updated_at": "2025-06-14T09:00:00+09:00"
}
```

### 2.1-3 ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼ˆã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ™‚ï¼‰

- PATCH`/api/users/current_plan`

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹:**

```json
{
  "current_plan": "premium"
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "current_plan": "premium",
  "updated_at": "2025-06-14T09:00:00+09:00"
}
```

---

## 2.2 åˆå›è¨­å®šãƒšãƒ¼ã‚¸

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:**Â `/api/care_settings/`
- **ãƒ¡ã‚½ãƒƒãƒ‰:**Â `GET`,Â `POST` ,`PATCH`
- **èª¬æ˜:**Â  è¨­å®šãƒšãƒ¼ã‚¸æƒ…å ±ï¼ˆãƒãƒãƒ»å­ä¾›ãƒ»çŠ¬ã®åå‰ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€PIN ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã©ï¼‰

### 2.2-1 æ–°è¦ç™»éŒ²ï¼ˆåˆå›è¨­å®šï¼‰

- POST`/api/care_settings`

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹:**

```json
{
  "parent_name": "ã¾ã‚†ã¿ãƒãƒ",
  "child_name": "ã•ãã¡ã‚ƒã‚“",
  "dog_name": "ã“ã‚ã‚“",
  "care_start_date": "2025-06-14",
  "care_end_date": "2025-07-14",
  "morning_meal_time": "07:00",
  "night_meal_time": "18:00",
  "walk_time": "17:00",ã€€ã€€
  "care_password": "1234",
  "care_clear_status": "not_cleared"
}
â€» `user_id` ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ Firebase ã®èªè¨¼æƒ…å ±ã‹ã‚‰è‡ªå‹•ã§ç´ã¥ã‘ã‚‹å‰æ
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "id": 5,
  "user_id": "1fc99ee4-87e6-4a58-bbeb-a8f122b4567d",
  "parent_name": "ã¾ã‚†ã¿ãƒãƒ",
  "child_name": "ã•ãã¡ã‚ƒã‚“",
  "dog_name": "ã“ã‚ã‚“",
  "care_start_date": "2025-06-14",
  "care_end_date": "2025-07-14",
  "morning_meal_time": "07:00:00",
  "night_meal_time": "18:00:00",
  "walk_time": "17:00:00",
  "care_password": "1234",
  "care_clear_status": "not_cleared",
  "created_at": "2025-06-14T08:00:00+09:00",
  "updated_at": "2025-06-14T09:00:00+09:00"
}
```

æ•£æ­©ï¼ˆ"walk_time"ï¼‰ï¼šã“ã®æ™‚é–“ã¾ã§ã«ã—ãŸã„ â†’first_walk_time ã¨ last_walk_time ä½œã£ã¦ãã®é–“ã«æ•£æ­©è¡Œã£ãŸã‹ã‚’åˆ¤æ–­ã™ã‚‹ï¼ˆå®Ÿè£…æ™‚ã«å¾®èª¿æ•´ã—ã¦ãã®ãŒã„ã„ã‹ã‚‚ï¼‰

### 2.2-2 è‡ªåˆ†ã®è¨­å®šæƒ…å ±ã‚’å–å¾—

- GET`/api/care_settings/me`
- å®Ÿè£…æ™‚ã€`verify_firebase_token()` ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç‰¹å®šã—ã¦ã‹ã‚‰ `care_settings.find_first(where={"user_id": user.id})`

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "id": 5,
  "parent_name": "ã¾ã‚†ã¿ãƒãƒ",
  "child_name": "ã•ãã¡ã‚ƒã‚“",
  "dog_name": "ã“ã‚ã‚“",
  "care_start_date": "2025-06-14",
  "care_end_date": "2025-07-14",
  "morning_meal_time": "07:00:00",
  "night_meal_time": "18:00:00",
  "walk_time": "17:00:00"
}
```

### 2.2-3 å†ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ˆè¨­å®šã®ãƒªã‚»ãƒƒãƒˆ or ç·¨é›†ï¼‰

- PATCH`/api/care_settings/:id`

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ï¼ˆç·¨é›†ãƒ»å†ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ï¼‰:**

```json
{
  "care_start_date": "2025-06-15",
  "care_end_date": "2025-07-15",
  "care_clear_status": "not_cleared"
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "care_clear_status": "not_cleared"
}
```

### 2.2-4 ç®¡ç†ç”»é¢ã‚¢ã‚¯ã‚»ã‚¹ç”¨ PIN èªè¨¼

- POST`/api/care_settings/verify_pin`
- åˆå›ã® `/api/care_settings` ç™»éŒ²æ™‚ã«ä¿å­˜ã•ã‚Œã‚‹ `"care_password"` ã‚’ä½¿ã£ã¦ç…§åˆ

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ï¼ˆç·¨é›†ãƒ»å†ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ï¼‰:**

```json
{
  "input_password": "1234"
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "verified": true
}
```

â€» PIN ãŒä¸€è‡´ã—ãªã„å ´åˆï¼š

```json
{
  "verified": false
}
```

### 2.2-5 ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢çŠ¶æ…‹ã‚’æ›´æ–°

- PATCH`/api/care_settings/:id/clear` ï¼ˆä¸€éƒ¨æ›´æ–°ï¼ˆ`care_clear_status` ã ã‘ã‚’å¤‰æ›´ï¼‰ã®ãŸã‚ PUT ã§ã¯ãªã PATCH ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã—ãŸæœŸé–“ã‚’å…¨ã¦é”æˆã—ãŸã¨ãã«ã€`care_settings.care_clear_status` ã‚’ `"cleared"` ã«æ›´æ–°ã™ã‚‹
- å¤±æ•—æ™‚ã¯åçœãƒšãƒ¼ã‚¸ï¼ˆ2.4ï¼‰ã«é·ç§»

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹:**

```json
{
  "care_clear_status": "cleared"
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "care_clear_status": "cleared"
}
```

---

## 2.3 ãŠä¸–è©±è¨˜éŒ²

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:**Â `/api/care_logs/`
- **ãƒ¡ã‚½ãƒƒãƒ‰:**Â `GET`,Â `POST` ,`PATCH`
- **èª¬æ˜:**Â  æ¯æ—¥ã®è¨˜éŒ²ï¼ˆæœã”ã¯ã‚“ãƒ»å¤œã”ã¯ã‚“ãƒ»æ•£æ­©ã®å®Ÿæ–½çŠ¶æ³ãªã©ï¼‰ã‚’è¨˜éŒ²ã™ã‚‹
  - å„æ—¥ä»˜ã”ã¨ã« 1 ä»¶ã®ãƒ¬ã‚³ãƒ¼ãƒ‰
  - `care_setting_id` ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§è‡ªå‹•æŒ¿å…¥ï¼‰ã¯`care_settings.id` ï¼ˆè¨­å®šãƒšãƒ¼ã‚¸ã® IDï¼‰ã¨ç´ã¥ã‘

### 2.3-1 æœ¬æ—¥ã®è¨˜éŒ²ã‚’å–å¾—ï¼ˆä¿è­·è€…ç”¨ï¼‰

- GET`/api/care_logs/today`

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "id": 1,
  "care_setting_id": 1,
  "date": "2025-06-14",
  "fed_morning": true,
  "fed_night": false,
  "created_at": "2025-06-14T08:00:00+09:00"
}
```

### 2.3-2 æ–°è¦è¨˜éŒ²ï¼ˆåˆå›ãƒŸãƒƒã‚·ãƒ§ãƒ³é”æˆæ™‚ï¼‰

- POST`/api/care_logs`
- é€šå¸¸ã¯ 1 æ—¥ 1 ä»¶ã€‚ã™ã§ã«è¨˜éŒ²ãŒã‚ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ `PATCH` ã¸èª˜å°ã€‚

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹:**

```json
{
  "date": "2025-06-14",
  "fed_morning": true,
  "fed_night": false
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "id": 21,
  "care_setting_id": 5,
  "date": "2025-06-14",
  "fed_morning": true,
  "fed_night": false,
  "created_at": "2025-06-14T09:15:00+09:00"
}
```

### 2.3-3 æ—¢å­˜ãƒ­ã‚°ã®æ›´æ–°ï¼ˆå¾Œã‹ã‚‰å¤œã”ã¯ã‚“ã‚’æŠ¼ã—ãŸãªã©ï¼‰

- PATCH`/api/care_logs/:id`

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹(å¤œã”ã¯ã‚“ã‚’å¾Œã‹ã‚‰è¿½åŠ ):**

```json
{
  "fed_night": true
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "id": 21,
  "care_setting_id": 5,
  "date": "2025-06-14",
  "fed_morning": true,
  "fed_night": true,
  "created_at": "2025-06-14T09:15:00+09:00"
}
```

---

## 2.4 åçœæ–‡

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:**Â `/api/reflection_notes/`
- **ãƒ¡ã‚½ãƒƒãƒ‰:**Â `GET`,Â `POST` ,`PATCH`
- **èª¬æ˜:**Â  åçœæ–‡ã¯å­ä¾›ãŒæ›¸ãï¼ä¿è­·è€…ã®æ‰¿èªãƒ•ãƒ©ã‚°ä»˜ã
  - å­ã©ã‚‚ãŒåçœæ–‡ã‚’æ›¸ã â†’ ä¿è­·è€…ãŒç¢ºèªï¼†æ‰¿èª
  - æ‰¿èªã•ã‚Œã‚‹ ï¼ å†ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒœã‚¿ãƒ³ â†’ æ–°ã—ã„ `care_settings` ã‚’ç™»éŒ²ï¼ˆï¼ãƒªã‚»ãƒƒãƒˆï¼‰
  - `care_setting_id` ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§è‡ªå‹•æŒ¿å…¥
  - `content` ã¯æ–‡å­—æ•°åˆ¶é™ã‚’è¡Œã†

### 2.4-1 åçœæ–‡ä¸€è¦§ã‚’å–å¾—ï¼ˆä¿è­·è€…ç”¨ï¼‰

- GET`/api/reflection_notes`

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "id": 1,
  "care_setting_id": 5,
  "content": "ã­ã¼ã†ã—ã¦ã‚ã•ã”ã¯ã‚“ã‚’ã‚ã™ã‚Œã¾ã—ãŸã€‚ã“ã‚ã‚“ã€ã”ã‚ã‚“ã­ã€‚",
  "approved_by_parent": false,
  "created_at": "2025-06-14T10:00:00+09:00",
  "updated_at": "2025-06-14T10:00:00+09:00"
}
```

### 2.4-2 å­ã©ã‚‚ãŒåçœæ–‡ã‚’æ–°è¦æŠ•ç¨¿

- POST`/api/reflection_notes`
- `care_setting_id` ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§è‡ªå‹•è£œå®Œï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨­å®šã‚’å–å¾—ï¼‰

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹:**

```json
{
  "content": "ã“ã‚ã‚“ã®ã•ã‚“ã½ã‚’ã‚ã™ã‚Œã¦ã—ã¾ã£ãŸã€‚ã¤ãã¯ãã‚’ã¤ã‘ã‚‹ï¼"
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "id": 2,
  "content": "ã“ã‚ã‚“ã«ã”ã¯ã‚“ã‚’ã‚ã™ã‚Œã¦ã—ã¾ã£ãŸã€‚ã¤ãã¯ãã‚’ã¤ã‘ã‚‹ï¼",
  "approved_by_parent": false,
  "created_at": "2025-06-14T10:15:00+09:00"
}
```

### 2.4-3 ä¿è­·è€…ãŒåçœæ–‡ã‚’æ‰¿èªï¼ˆå†ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒœã‚¿ãƒ³æŠ¼ä¸‹ï¼‰

- PATCH`/api/reflection_notes/:id/approve`

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹:**

```json
{
  "approved_by_parent": true
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "approved_by_parent": true
}
```

---

## 2.5 çŠ¬ã®ã²ã¨ã“ã¨å±¥æ­´

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:**Â `/api/message_logs/`
- **ãƒ¡ã‚½ãƒƒãƒ‰:**Â `POST`
- **èª¬æ˜:**Â  çŠ¬ãŒã²ã¨ã“ã¨ã‚’ã—ã‚ƒã¹ã‚‹ã€‚æœ‰æ–™ä¼šå“¡ã¯ LLM ãƒ™ãƒ¼ã‚¹ã€ç„¡æ–™ä¼šå“¡ã¯æ±ºã¾ã£ãŸã‚»ãƒªãƒ•
  - ç´ã¥ãå¯¾è±¡ï¼š`user_id` ï¼ˆUUIDï¼‰ã¯ç™ºè©±å¯¾è±¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
  - `is_llm_based` ã¯ Open AI ã«ã‚ˆã‚‹ç”Ÿæˆã‹ã©ã†ã‹
  - ãƒ—ãƒ¬ãƒŸã‚¢ãƒ åˆ¤å®šï¼š`users.current_plan === 'premium'` ã§åˆ‡ã‚Šåˆ†ã‘ã‚‹
  - ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š `is_llm_based: false` ã®å›ºå®šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ æŠ½å‡º
  - `content` ã¯æ–‡å­—æ•°åˆ¶é™ã‚’è¡Œã†

### 2.5-1 æœ€æ–°ã®çŠ¬ã®ã²ã¨ã“ã¨ã‚’å–å¾— + ä¿å­˜

- POST`/api/message_logs/generate`
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸã¨ãã«å‘¼ã°ã‚Œã€è¡¨ç¤ºç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç”Ÿæˆã—ã€ãã®ã¾ã¾ä¿å­˜ã—ã¦ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«è¿”ã™

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ç©ºé€ä¿¡ or ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã ã‘ï¼‰:**

```json
{}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹ï¼ˆä¿å­˜ï¼‹è¡¨ç¤ºï¼‰:**

```json
{
  "id": 12,
  "user_id": "1fc99ee4-87e6-4a58-bbeb-a8f122b4567d",
  "content": "ãã‚‡ã†ã‚‚ãŠã•ã‚“ã½ã‚ã‚ŠãŒã¨ã†ï¼ã“ã‚ã‚“ ã†ã‚Œã—ã„ï¼",
  "is_llm_based": true,
  "created_at": "2025-06-14T18:00:00+09:00"
}
```

â€»è¡¨ç¤ºå¯¾è±¡ã¯ `user_id` ã«ç´ã¥ãæœ€æ–°ã®ãƒ­ã‚° 1 ä»¶

---

## 2.6 æ•£æ­©ãƒŸãƒƒã‚·ãƒ§ãƒ³

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:**Â `/api/walk_missions/`
- **ãƒ¡ã‚½ãƒƒãƒ‰:**Â `GET`,Â `POST` ,`PATCH`
- **èª¬æ˜:**Â  æ•£æ­©ã®æˆåŠŸï¼å¤±æ•—ã€ä¿è­·è€…ç¢ºèªã®æœ‰ç„¡ã€çŠ¬ã®æ‚²ã—ã„ä¸€è¨€ãªã©ã‚’è¨˜éŒ²

### 2.6-1 æ–°è¦ãƒŸãƒƒã‚·ãƒ§ãƒ³çµæœã®ç™»éŒ²

- POST`/api/walk_missions`
- å‡¦ç†ã®æµã‚Œï¼š
  1. å­ã©ã‚‚ãŒã€Œæ•£æ­©é–‹å§‹ã€ãƒœã‚¿ãƒ³æŠ¼ã™ â†’ Geolocation API ã§è·é›¢æ¸¬å®š
  2. æ•£æ­©çµ‚äº†å¾Œã«ãƒ•ãƒ­ãƒ³ãƒˆã§è·é›¢ã‚’åˆ¤å®šï¼ˆ1km ä»¥ä¸Š or æœªæº€ï¼‰
  3. ã‚µãƒ¼ãƒãƒ¼ã«ã€ŒæˆåŠŸ or å¤±æ•—ã€çµæœã‚’é€ä¿¡ã—ã€ãƒŸãƒƒã‚·ãƒ§ãƒ³çµæœã‚’è¨˜éŒ²

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ï¼ˆå¤±æ•—ã—ãŸå ´åˆï¼‰:**

```json
{
  "care_log_id": 31,
  "started_at": "2025-06-14T18:00:00+09:00",
  "ended_at": "2025-06-14T18:15:00+09:00"
  "total_distance_m": 1200,
  "resule": "success"
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "id": 18,
  "care_log_id": 31,
  "started_at": "2025-06-14T18:00:00+09:00",
  "ended_at": "2025-06-14T18:15:00+09:00"
  "total_distance_m": 1200,
  "resule": "success",
  "created_at": "2025-06-14T18:15:00+09:00"
}
```

### 2.6-2 ä¸€è¦§å–å¾—ï¼ˆä¿è­·è€…ç”»é¢ç”¨ï¼‰

- GET`/api/walk_missions`

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
[
  {
    "id": 18,
    "total_distance_m": 1200,
    "result": "success",
    "created_at": "2025-06-14T18:15:00+09:00"
  },
  {
    "id": 19,
    "total_distance_m": 900,
    "result": "failed",
    "created_at": "2025-06-15T18:00:00+09:00"
  }
]
```

---

## 2.7 Stripe æ±ºæ¸ˆã®ãƒ­ã‚° ç¢ºèª

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:**Â `/api/payment/`
- **ãƒ¡ã‚½ãƒƒãƒ‰:**Â `GET`,Â `POST`
- **èª¬æ˜:**Â PaymentIntent IDã€æ±ºæ¸ˆæˆåŠŸçŠ¶æ…‹ã€èª²é‡‘æ™‚åˆ»ã€Charge ID ç­‰

### 2.7-1 ãƒ—ãƒ¬ãƒŸã‚¢ãƒ è³¼å…¥ã‚’é–‹å§‹ã™ã‚‹ï¼ˆStripe Checkout ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼‰

- POST`/api/payment/checkout-session`
- èª¬æ˜ï¼šStripe Checkout ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ï¼ˆå¤±æ•—ã—ãŸå ´åˆï¼‰:**

```json
{
  "product_name": "premium_plan"
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "checkout_url": "https://checkout.stripe.com/pay/cs_test_abc123"
}
```

**ã‚µãƒ¼ãƒãƒ¼å‡¦ç†ï¼š**

- Firebase ã® ID ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ `firebase_uid` ã‚’å–å¾—
- Stripe Checkout ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
- `stripe_session_id` ã‚’å–å¾—ã—ã¦ä¿å­˜ï¼ˆor ä¿æŒï¼‰
- DB æ›¸ãè¾¼ã¿ã¯ Webhook å´ã§å®Ÿæ–½ã™ã‚‹ãŸã‚ã“ã“ã§ã¯ä¸è¦

### 2.7-2 è³¼å…¥ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª

- GET`/api/payment/status`
- èª¬æ˜ï¼šç®¡ç†è€…ç”»é¢ã§ç¾åœ¨ã®è³¼å…¥ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ã€‚Firebase èªè¨¼å¿…é ˆã€‚

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "plan": "premium",
  "purchased_at": "2025-06-14T10:15:00+09:00",
  "payment_intent_id": "pi_1ABC123",
  "status": "paid"
}
```

**ã‚µãƒ¼ãƒãƒ¼å‡¦ç†ï¼š**

- Firebase ã® ID ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ `firebase_uid` ã‚’å–å¾—
- `payment` ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ `status = 'paid'` ã®æœ€æ–°ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
- ãƒ—ãƒ©ãƒ³æƒ…å ±ãªã©ã¨åˆã‚ã›ã¦è¿”å´

### 2.7-3 æ”¯æ‰•ã„æƒ…å ±ã‚’è¨˜éŒ²

- POST`/api/payment/webhook`
- èª¬æ˜ï¼šStripe Webhook ã‚’å—ã‘å–ã£ã¦æ”¯æ‰•ã„æƒ…å ±ã‚’è¨˜éŒ²

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ï¼ˆStripe ã‹ã‚‰è‡ªå‹•é€ä¿¡ï¼‰:**

```json
{
  "id": "evt_1xyz456",
  "type": "checkout.session.completed",
  "data": {
    "object": {
      "id": "cs_test_abc123",
      "payment_intent": "pi_1ABC123",
      "amount_total": 300,
      "currency": "jpy",
      "customer_email": "user@example.com",
      "payment_status": "paid"
    }
  }
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "status": "ok"
}
```

**ã‚µãƒ¼ãƒãƒ¼å‡¦ç†ã®æµã‚Œï¼š**

1. Stripe ç½²åã‚’æ¤œè¨¼ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
2. å—ã‘å–ã£ãŸ`stripe_session_id`ã‚’ã‚‚ã¨ã«é‡è¤‡ã‚’ç¢ºèª
3. `payment` ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä»¥ä¸‹ã®æƒ…å ±ã‚’ç™»éŒ²ï¼š

| é …ç›®                       | å€¤ã®å–å¾—å…ƒ                                   |
| -------------------------- | -------------------------------------------- |
| `stripe_session_id`        | `object.id`                                  |
| `stripe_payment_intent_id` | `object.payment_intent`                      |
| `amount`                   | `object.amount_total`                        |
| `currency`                 | `object.currency`                            |
| `status`                   | `object.payment_status`                      |
| `firebase_uid`             | ã‚»ãƒƒã‚·ãƒ§ãƒ³ã® metadata ã«å«ã‚ã¦ãŠãã¨å–å¾—å¯èƒ½ |
| `created_at`               | ç¾åœ¨æ™‚åˆ»                                     |

---

## 2.8 Stripe ã‹ã‚‰ã® Webhook ã‚¤ãƒ™ãƒ³ãƒˆã®è¨˜éŒ²

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:**Â `/api/webhook_events/`
- **ãƒ¡ã‚½ãƒƒãƒ‰:**Â `GET`,Â `POST`
- **èª¬æ˜:**Â Stripe ã‹ã‚‰é€ã‚‰ã‚Œã¦ãã‚‹ Webhook é€šçŸ¥ã‚’è¨˜éŒ²ãƒ»ç›£æŸ»ã™ã‚‹ãŸã‚ã®å†…éƒ¨ç”¨é€” APIã€‚ã€ŒæˆåŠŸã—ã¦ã„ã‚ˆã†ãŒå¤±æ•—ã—ã¦ã„ã‚ˆã†ãŒã€ã™ã¹ã¦è¨˜éŒ²ã™ã‚‹ã€ã“ã¨ã‚’ç›®çš„ã¨ã™ã‚‹ã€‚

### 2.8-1 Stripe Webhook ã‚¤ãƒ™ãƒ³ãƒˆã®å—ä¿¡å‡¦ç†

- POST`/api/webhook-events/stripe`

**ğŸ“¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ï¼ˆStripe ãŒè‡ªå‹•é€ä¿¡ï¼‰:**

```json
{
  "id": "evt_1xyz456",
  "type": "checkout.session.completed",
  "data": {
    "object": {
      "id": "cs_test_abc123",
      "payment_intent": "pi_1ABC123",
      "amount_total": 300,
      "currency": "jpy",
      "customer_email": "user@example.com",
      "payment_status": "paid"
    }
  }
}
```

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "status": "ok"
}
```

**ã‚µãƒ¼ãƒãƒ¼å´ã®å‡¦ç†æ¦‚è¦ï¼š**

1. Stripe ç½²åã‚’æ¤œè¨¼ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ `Stripe-Signature`ï¼‰
2. `webhook_events` ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼š

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å               | å€¤                                       |
| -------------------------- | ---------------------------------------- |
| `id`                       | `evt_1xyz456`ï¼ˆStripe ã‚¤ãƒ™ãƒ³ãƒˆ IDï¼‰      |
| `event_type`               | `checkout.session.completed`             |
| `stripe_session_id`        | `cs_test_abc123`ï¼ˆCheckout Session IDï¼‰  |
| `stripe_payment_intent_id` | `pi_1ABC123`                             |
| `customer_email`           | `user@example.com`                       |
| `amount`                   | 300                                      |
| `currency`                 | `"jpy"`                                  |
| `payment_status`           | `"paid"`                                 |
| `payload`                  | å—ä¿¡ã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆå…¨æ–‡ï¼ˆJSONï¼‰           |
| `received_at`              | å‡¦ç†æ™‚ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—                   |
| `processed`                | `true` ã¾ãŸã¯ `false`ï¼ˆå‡¦ç†æˆåŠŸã§ trueï¼‰ |
| `error_message`            | ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°è¨˜éŒ²ã€æˆåŠŸæ™‚ã¯ null        |

å‡¦ç†ãŒæˆåŠŸã™ã‚Œã° `processed: true`ã€ã‚¨ãƒ©ãƒ¼æ™‚ã¯ `false` + `error_message` ã‚’è¨˜éŒ²

### 2.8-2 Webhook ã‚¤ãƒ™ãƒ³ãƒˆã®è©³ç´°å–å¾—

- GET`/api/webhook-events/:id`

**ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**

```json
{
  "id": "evt_1xyz456",
  "event_type": "checkout.session.completed",
  "stripe_session_id": "cs_test_abc123",
  "stripe_payment_intent_id": "pi_1ABC123",
  "customer_email": "user@example.com",
  "amount": 300,
  "currency": "jpy",
  "payment_status": "paid",
  "processed": true,
  "error_message": null,
  "payload": {
    "id": "evt_1xyz456",
    "type": "checkout.session.completed",
    "data": {
      "object": {
        "id": "cs_test_abc123",
        "payment_intent": "pi_1ABC123",
        "amount_total": 300,
        "currency": "jpy",
        "customer_email": "user@example.com",
        "payment_status": "paid"
      }
    }
  },
  "received_at": "2025-06-14T10:14:59+09:00"
}
```

**ã‚µãƒ¼ãƒãƒ¼å‡¦ç†ï¼š**

- Firebase ã® ID ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ `firebase_uid` ã‚’å–å¾—
- `payment` ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ `status = 'paid'` ã®æœ€æ–°ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
- ãƒ—ãƒ©ãƒ³æƒ…å ±ãªã©ã¨åˆã‚ã›ã¦è¿”å´

---

## 3. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰

- `200 OK`: æ­£å¸¸çµ‚äº†
- `201 Created`: ãƒªã‚½ãƒ¼ã‚¹ä½œæˆ
- `400 Bad Request`: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼
- `401 Unauthorized`: èªè¨¼ã‚¨ãƒ©ãƒ¼
- `404 Not Found`: ãƒªã‚½ãƒ¼ã‚¹æœªæ¤œå‡º
