# テスト設計書

## 概要・目的

このテスト設計書は、犬のお世話体験アプリ「わん 🐾 みっしょん」の各機能において、バックエンド・フロントエンド・外部サービス（Firebase, Stripe 等）が正しく連携し、ユーザーに対して想定通りの体験を提供できるかを検証するための詳細なテスト項目を記載したものである。

本書では、バックエンドとフロントエンドの単体テストおよび統合テストを対象にし、ミッション機能の基本的な動作確認を目的とする。

## テスト方針

本テスト設計書では、以下の方針に基づいてテストケースを設計する。

- \*想定ユーザーの行動（ユースケース）\*\*に基づき、主に「保護者による初期設定」「お世話記録」「犬からのメッセージ生成」「反省文の投稿・承認」などの一連の利用フローをカバーする。
- **クリティカルパス**として、「お世話記録ができる」「PIN で認証ができる」「プレミアム決済が成功する」といった**アプリのコア体験を阻害しないこと**に焦点を当て、関連機能を重点的にテストする。
- **優先順位の高い機能**（ユーザー登録、認証、記録保存、メッセージ生成、Stripe 決済等）は異常系まで網羅し、**エラー時の復旧性**や**モックによる外部依存の分離**も含めて設計している。

また、今後フロントエンドや統合テストを拡充する際も、上記の流れに基づいた利用者視点の設計方針を維持する。

## 目標カバレッジ率：80％

目標カバレッジ率は、品質と工数のバランスを考慮し 80％とする。業界でも広く採用されている基準であり、主要なビジネスロジックを網羅しつつ、過剰なコストを避ける現実的な目標値として設定。

## **単体テストの対象**

以下の機能に関して単体テスト・機能テストを実施する。

## **テスト対象 1：バックエンド（FastAPI）**

### **① テスト観点（エンドポイント`/api/users`）**

- ユーザー新規登録・ログインユーザー情報取得

### **テストケース**

- ユーザー新規登録 API `/api/users` （POST）

| テスト ID   | テストケース名                 | 前提条件                           | テスト手順                                                                                                    | 期待結果                                                           |
| ----------- | ------------------------------ | ---------------------------------- | ------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------ |
| TC-USER-001 | ユーザー新規登録が成功する     | 対象の Firebase UID は未登録       | 1. `firebase_uid`, `email`, `current_plan`, `is_verified` を含む JSON を POST2. `/api/users` にリクエスト送信 | ステータスコード `201`レスポンスに登録されたユーザー情報が含まれる |
| TC-USER-002 | 登録済みユーザーの登録はエラー | 対象の Firebase UID が既に存在する | 1. 同じ `firebase_uid` で `/api/users` に POST リクエスト                                                     | ステータスコード `409detail` に `"User already ex`                 |

- ログインユーザー情報取得 `/api/users/me` （GET）

| テスト ID   | テストケース名                       | 前提条件                                      | テスト手順                                                                  | 期待結果                                                                         |
| ----------- | ------------------------------------ | --------------------------------------------- | --------------------------------------------------------------------------- | -------------------------------------------------------------------------------- |
| TC-USER-003 | ログイン中ユーザー情報を取得できる   | `firebase_uid` に該当するユーザーが存在する   | 1. Authorization ヘッダーにトークン付きで `/api/users/me` に GET リクエスト | ステータスコード `200`レスポンスに `email`, `current_plan`, `is_verified` を含む |
| TC-USER-004 | 存在しないユーザー情報は取得できない | `firebase_uid` に該当するユーザーが存在しない | 1. Authorization ヘッダーにトークン付きで `/api/users/me` に GET リクエスト | ステータスコード `404detail` に `"User not found"` を含む                        |

### 使用したモック

| モック対象                        | 説明                   |
| --------------------------------- | ---------------------- |
| `prisma_client.users.find_unique` | ユーザーの存在チェック |
| `prisma_client.users.create`      | 新規登録時に使用       |
| `verify_firebase_token`           | Firebase UID の取得    |

---

### **② テスト観点（エンドポイント`/api/care_settings`）**

- お世話設定の登録・取得・4 ケタ PIN の照合

### **テストケース**

- お世話設定の登録 API `/api/care_settings` （POST）

| テスト ID   | テストケース名                                | 前提条件                                    | テスト手順                                                                           | 期待結果                                                                                |
| ----------- | --------------------------------------------- | ------------------------------------------- | ------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------- |
| TC-CARE-001 | お世話設定が正常に登録できる                  | Firebase UID に該当するユーザーが存在する   | 1. Authorization 付きで、必要なフィールドを含む JSON を `/api/care_settings` に POST | ステータスコード `201`、レスポンスに登録内容が含まれる                                  |
| TC-CARE-002 | ユーザーが存在しない場合はエラーになる        | Firebase UID に該当するユーザーが存在しない | 1. Authorization 付きで `/api/care_settings` に POST                                 | ステータスコード `404`、`detail` に `"User not found"` を含む                           |
| TC-CARE-003 | サーバー側でエラーが発生した場合は 500 になる | ユーザーは存在するが DB 操作時に例外発生    | 1. Authorization 付きで `/api/care_settings` に POST                                 | ステータスコード `500`、`detail` に `"お世話設定の登録中にエラーが発生しました"` を含む |

- お世話設定の取得 API `/api/care_settings/me`（GET）

| テスト ID   | テストケース名                             | 前提条件                                                 | テスト手順                                                                | 期待結果                                                              |
| ----------- | ------------------------------------------ | -------------------------------------------------------- | ------------------------------------------------------------------------- | --------------------------------------------------------------------- |
| TC-CARE-004 | お世話設定を正常に取得できる               | Firebase UID に対応するユーザーと CareSetting が存在する | 1. Authorization ヘッダー付きで `/api/care_settings/me` に GET リクエスト | ステータスコード `200`、レスポンスにお世話設定情報が含まれる          |
| TC-CARE-005 | ユーザーが存在しない場合は取得できない     | Firebase UID に対応するユーザーが存在しない              | 1. Authorization ヘッダー付きで `/api/care_settings/me` に GET リクエスト | ステータスコード `404`、`detail` に `"User not found"` を含む         |
| TC-CARE-006 | CareSetting が存在しない場合は取得できない | ユーザーは存在するが CareSetting が存在しない            | 1. Authorization ヘッダー付きで `/api/care_settings/me` に GET リクエスト | ステータスコード `404`、`detail` に `"Care setting not found"` を含む |

- PIN 認証 API `/api/care_settings/verify_pin`（POST）

| テスト ID   | テストケース名                   | 前提条件                                         | テスト手順                                             | 期待結果                                                                       |
| ----------- | -------------------------------- | ------------------------------------------------ | ------------------------------------------------------ | ------------------------------------------------------------------------------ |
| TC-CARE-007 | PIN 認証が成功する               | ユーザーが存在し、登録済み PIN と入力 PIN が一致 | 1. Authorization 付きで `input_password` を POST       | ステータスコード `200`、`verified: true` を返す                                |
| TC-CARE-008 | PIN が一致しない場合は失敗する   | ユーザーが存在し、PIN が一致しない               | 1. Authorization 付きで異なる `input_password` を POST | ステータスコード `200`、`verified: false` を返す                               |
| TC-CARE-009 | ユーザーが存在しない場合はエラー | Firebase UID に対応するユーザーが存在しない      | 1. Authorization 付きで `input_password` を POST       | ステータスコード `404`、`detail` に `"User not found"` を含む                  |
| TC-CARE-010 | サーバーエラー時は 500 を返す    | care_settings.find_first 実行時に例外発生        | 1. Authorization 付きで `input_password` を POST       | ステータスコード `500`、`detail` に `"PIN認証中にエラーが発生しました"` を含む |

### 使用したモック

| モック対象                               | 説明                     |
| ---------------------------------------- | ------------------------ |
| `prisma_client.users.find_unique`        | ユーザーの存在チェック   |
| `prisma_client.care_settings.find_first` | ユーザーの既存設定取得   |
| `prisma_client.care_settings.create`     | 新規作成                 |
| `prisma_client.care_settings.update`     | 編集・PIN 検証・状態更新 |
| `verify_firebase_token`                  | Firebase UID の取得      |

---

### **③ テスト観点（エンドポイント`/api/care_logs`）**

- 1 日 1 件のお世話記録の登録・更新・一覧

### **テストケース**

- お世話記録の登録 API `/api/care_logs` （POST）

| テスト ID  | テストケース名                       | 前提条件                                                                      | テスト手順                                                             | 期待結果                                                                      |
| ---------- | ------------------------------------ | ----------------------------------------------------------------------------- | ---------------------------------------------------------------------- | ----------------------------------------------------------------------------- |
| TC-LOG-001 | お世話記録が正常に登録できる         | Firebase UID に該当するユーザーと care_setting が存在し、該当日の記録が未登録 | 1. Authorization 付きで、care_log の JSON を `/api/care_logs` に POST  | ステータスコード `201`、登録された care_log 情報を返す                        |
| TC-LOG-002 | 同じ日付の記録が既にある場合はエラー | 同日付の care_log が既に存在する                                              | 1. Authorization 付きで同じ日付の care_log を `/api/care_logs` に POST | ステータスコード `400`、`detail` に `"この日付の記録は既に存在します"` を含む |

- お世話記録の更新 API `/api/care_logs/{care_log_id}`（PATCH）

| テスト ID  | テストケース名                        | 前提条件                         | テスト手順                                                                        | 期待結果                                                          |
| ---------- | ------------------------------------- | -------------------------------- | --------------------------------------------------------------------------------- | ----------------------------------------------------------------- |
| TC-LOG-003 | お世話記録を正常に更新できる          | 指定した care_log ID が存在する  | 1. Authorization 付きで更新フィールドを含む JSON を `/api/care_logs/123` に PATCH | ステータスコード `200`、更新後の care_log 情報を返す              |
| TC-LOG-004 | 存在しない care_log ID の場合はエラー | 指定 ID の care_log が存在しない | 1. Authorization 付きで `/api/care_logs/999` に PATCH                             | ステータスコード `404`、`detail` に `"Care log not found"` を含む |

- 当日の記録取得 API `/api/care_logs/today`（GET）

| テスト ID  | テストケース名                                | 前提条件                                            | テスト手順                                                                                | 期待結果                                                                           |
| ---------- | --------------------------------------------- | --------------------------------------------------- | ----------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------- |
| TC-LOG-005 | 当日の記録を正常に取得できる                  | care_setting が本人のもので、当日の記録が存在する   | 1. Authorization 付きで `care_setting_id` と `date` を指定して GET `/api/care_logs/today` | ステータスコード `200`、当日の care_log 情報を返す                                 |
| TC-LOG-006 | 当日の記録が存在しない場合は初期値を返す      | care_setting が本人のもので、当日の記録が存在しない | 1. 同上                                                                                   | ステータスコード `200`、`care_log_id: null`、`fed_morning: false` 等の初期値を返す |
| TC-LOG-007 | 他人の care_setting_id を指定した場合はエラー | Firebase UID と care_setting_id が一致しない        | 1. 不正な `care_setting_id` で `/api/care_logs/today` に GET                              | ステータスコード `403`、`detail` に `"不正な care_setting_id です"` を含む         |

- 日付指定記録取得 API `/api/care_logs/by_date`（GET）

| テスト ID  | テストケース名                                | 前提条件                                              | テスト手順                                                                                  | 期待結果                                                                           |
| ---------- | --------------------------------------------- | ----------------------------------------------------- | ------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------- |
| TC-LOG-008 | 指定日のお世話記録を取得できる                | care_setting が本人のもので、該当日の記録が存在する   | 1. Authorization 付きで `care_setting_id` と `date` を指定して GET `/api/care_logs/by_date` | ステータスコード `200`、指定日の care_log 情報を返す                               |
| TC-LOG-009 | 指定日の記録が存在しない場合は初期値を返す    | care_setting が本人のもので、該当日の記録が存在しない | 1. 同上                                                                                     | ステータスコード `200`、`care_log_id: null`、`fed_morning: false` 等の初期値を返す |
| TC-LOG-010 | 他人の care_setting_id を指定した場合はエラー | Firebase UID と care_setting_id が一致しない          | 1. 不正な `care_setting_id` で `/api/care_logs/by_date` に GET                              | ステータスコード `403`、`detail` に `"不正な care_setting_id です"` を含む         |

- 記録一覧取得 API `/api/care_logs/list`（GET）

| テスト ID  | テストケース名                                | 前提条件                                            | テスト手順                                                                     | 期待結果                                                                   |
| ---------- | --------------------------------------------- | --------------------------------------------------- | ------------------------------------------------------------------------------ | -------------------------------------------------------------------------- |
| TC-LOG-011 | care_log を複数件取得できる                   | care_setting が本人のもので、複数件の記録が存在する | 1. Authorization 付きで `care_setting_id` を指定して GET `/api/care_logs/list` | ステータスコード `200`、`care_logs` 配列に記録一覧を返す                   |
| TC-LOG-012 | 記録が 0 件でも空配列を返す                   | care_setting が本人のもので、記録が存在しない       | 1. 同上                                                                        | ステータスコード `200`、空の `care_logs` 配列を返す                        |
| TC-LOG-013 | 他人の care_setting_id を指定した場合はエラー | Firebase UID と care_setting_id が一致しない        | 1. 不正な `care_setting_id` で `/api/care_logs/list` に GET                    | ステータスコード `403`、`detail` に `"不正な care_setting_id です"` を含む |

### 使用したモック

| モック対象                           | 説明                       |
| ------------------------------------ | -------------------------- |
| `prisma_client.users.find_unique`    | ユーザーの存在チェック     |
| `prisma_client.care_logs.find_first` | 同一日付のログ存在確認など |
| `prisma_client.care_logs.create`     | お世話ログの新規作成       |
| `prisma_client.care_logs.update`     | 状態変更や振り返り文の保存 |
| `prisma_client.care_logs.find_many`  | ログの一覧・日付取得など   |
| `verify_firebase_token`              | Firebase UID の取得        |

---

### **④ テスト観点（エンドポイント`/api/message_logs`）**

- 犬のひとことの生成・OpenAI メッセージ取得

### **テストケース**

- メッセージ生成 API `/api/message_logs/generate`（POST）

| テスト ID  | テストケース名                                         | 前提条件                                    | テスト手順                                                                                                | 期待結果                                                                        |
| ---------- | ------------------------------------------------------ | ------------------------------------------- | --------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------- |
| TC-MSG-001 | 無料プランユーザーは固定メッセージを受け取る           | ユーザーが `free` プラン                    | 1. Authorization 付きで `/api/message_logs/generate` に POST2. `random.choice` を固定で「わん！」にモック | ステータスコード `200`、`message: "わん！"` を返す                              |
| TC-MSG-002 | プレミアムプランユーザーは AI 生成メッセージを受け取る | ユーザーが `premium` プラン                 | 1. `get_openai_message` を `"おべんきょうするわん！"` にモック 2. POST リクエスト送信                     | ステータスコード `200`、`message: "おべんきょうするわん！"` を返す              |
| TC-MSG-003 | プレミアムプランだが OpenAI エラー時は固定メッセージ   | `get_openai_message` が例外を発生           | 1. `get_openai_message` を例外に 2. `random.choice` を「わん！」にモック                                  | ステータスコード `200`、`message: "わん！"` を返す                              |
| TC-MSG-004 | ユーザーが存在しない場合は 400 エラー                  | Firebase UID に対応するユーザーが存在しない | 1. `users.find_unique` を `None` にモック 2. POST リクエスト送信                                          | ステータスコード `400`、`detail: "Firebase UIDのユーザーが存在しません"` を含む |
| TC-MSG-005 | DB エラー時もフォールバックメッセージを返す            | `users.find_unique` が例外を発生            | 1. `users.find_unique` を例外に 2. `random.choice` を「わん！」にモック                                   | ステータスコード `200`、`message: "わん！」` を返す                             |

- OpenAI メッセージ取得関数 `get_openai_message`（ユニットテスト）

| テスト ID  | テストケース名                                    | 前提条件                               | テスト手順                                                                                 | 期待結果                                            |
| ---------- | ------------------------------------------------- | -------------------------------------- | ------------------------------------------------------------------------------------------ | --------------------------------------------------- |
| TC-MSG-006 | OpenAI が空レスポンスを返した場合は固定メッセージ | `choices[0].message.content` が `None` | 1. OpenAI クライアントをモックして空レスポンスを再現 2. `random.choice` を「わん！」に固定 | `get_openai_message()` の戻り値が `"わん！"` になる |

### 使用したモック

| モック対象                             | 説明                      |
| -------------------------------------- | ------------------------- |
| `prisma_client.users.find_unique`      | ユーザー存在チェック      |
| `prisma_client.message_logs.create`    | メッセージ保存（POST）    |
| `prisma_client.message_logs.find_many` | メッセージ一覧取得（GET） |
| `verify_firebase_token`                | Firebase UID の取得       |

---

### **⑤ テスト観点（エンドポイント`/api/reflection_notes`）**

- 反省文の登録・取得・承認

### **テストケース**

- 反省文の新規登録 API `/api/reflection_notes`（POST）

| テスト ID      | テストケース名                                    | 前提条件                                        | テスト手順                                                                       | 期待結果                                                                      |
| -------------- | ------------------------------------------------- | ----------------------------------------------- | -------------------------------------------------------------------------------- | ----------------------------------------------------------------------------- |
| TC-REFLECT-001 | 反省文を正常に登録できる                          | ユーザーと care_setting が存在する              | 1. Authorization 付きで `content` を含む JSON を `/api/reflection_notes` に POST | ステータスコード `201`、レスポンスに登録内容が含まれる                        |
| TC-REFLECT-002 | ユーザーが存在しない場合は 404 エラー             | Firebase UID に該当するユーザーが存在しない     | 1. Authorization 付きで POST                                                     | ステータスコード `404`、`detail` に `"ユーザーが見つかりません"` を含む       |
| TC-REFLECT-003 | care_setting が存在しない場合は 404 エラー        | ユーザーは存在するが、care_setting が存在しない | 1. Authorization 付きで POST                                                     | ステータスコード `404`、`detail` に `"お世話設定が見つかりません"` を含む     |
| TC-REFLECT-004 | 登録時にサーバーエラーが発生した場合は 500 エラー | Prisma の create 操作で例外発生                 | 1. Authorization 付きで POST                                                     | ステータスコード `500`、`detail` に `"DB登録時にエラーが発生しました"` を含む |

- 反省文の取得 API `/api/reflection_notes`（GET）

| テスト ID      | テストケース名                             | 前提条件                                                 | テスト手順                                             | 期待結果                                                                      |
| -------------- | ------------------------------------------ | -------------------------------------------------------- | ------------------------------------------------------ | ----------------------------------------------------------------------------- |
| TC-REFLECT-005 | 登録済みの反省文一覧を取得できる           | ユーザーと care_setting が存在し、反省文が 1 件以上存在  | 1. Authorization 付きで `/api/reflection_notes` に GET | ステータスコード `200`、反省文のリストを返す                                  |
| TC-REFLECT-006 | 反省文が 0 件でも空リストを返す            | ユーザーと care_setting は存在するが、反省文が存在しない | 1. Authorization 付きで GET                            | ステータスコード `200`、空配列 `[]` を返す                                    |
| TC-REFLECT-007 | ユーザーが存在しない場合は 404 エラー      | Firebase UID に対応するユーザーが存在しない              | 1. Authorization 付きで GET                            | ステータスコード `404`、`detail` に `"ユーザーが見つかりません"` を含む       |
| TC-REFLECT-008 | care_setting が存在しない場合は 404 エラー | ユーザーは存在するが、care_setting が存在しない          | 1. Authorization 付きで GET                            | ステータスコード `404`、`detail` に `"お世話設定が見つかりません"` を含む     |
| TC-REFLECT-009 | サーバーエラーが発生した場合は 500 エラー  | Prisma の操作で例外発生                                  | 1. Authorization 付きで GET                            | ステータスコード `500`、`detail` に `"DB取得時にエラーが発生しました"` を含む |

- 反省文の承認状態更新 API `/api/reflection_notes/{note_id}`（PATCH）

| テスト ID      | テストケース名                                        | 前提条件                                                   | テスト手順                                                  | 期待結果                                                      |
| -------------- | ----------------------------------------------------- | ---------------------------------------------------------- | ----------------------------------------------------------- | ------------------------------------------------------------- |
| TC-REFLECT-010 | 保護者が反省文の承認状態を更新できる                  | ユーザーと care_setting が存在し、対象 note が紐づいている | 1. Authorization 付きで `approved_by_parent: true` を PATCH | ステータスコード `200`、更新された note 情報を返す            |
| TC-REFLECT-011 | ユーザーが存在しない場合は 404 エラー                 | Firebase UID に対応するユーザーが存在しない                | 1. Authorization 付きで PATCH                               | ステータスコード `404`、`"ユーザーが見つかりません"` を含む   |
| TC-REFLECT-012 | care_setting が存在しない場合は 404 エラー            | ユーザーは存在するが care_setting が存在しない             | 1. Authorization 付きで PATCH                               | ステータスコード `404`、`"お世話設定が見つかりません"` を含む |
| TC-REFLECT-013 | 対象の note が存在しない場合は 403 エラー             | 指定 note が見つからない                                   | 1. Authorization 付きで PATCH                               | ステータスコード `403`、`"アクセスする権限"` を含む           |
| TC-REFLECT-014 | note の care_setting_id が一致しない場合は 403 エラー | note の care_setting_id が本人のものと異なる               | 1. Authorization 付きで PATCH                               | ステータスコード `403`、`"アクセスする権限"` を含む           |
| TC-REFLECT-015 | サーバーエラーが発生した場合は 500 エラー             | Prisma 操作中に例外発生                                    | 1. Authorization 付きで PATCH                               | ステータスコード `500`、`"反省文の更新中にエラー"` を含む     |

### 使用したモック

| モック対象                                 | 説明                           |
| ------------------------------------------ | ------------------------------ |
| `prisma_client.users.find_unique`          | ユーザー存在チェック           |
| `prisma_client.reflection_notes.create`    | ノートの新規作成               |
| `prisma_client.reflection_notes.find_many` | ノートの取得（一覧）           |
| `prisma_client.reflection_notes.update`    | 再チャレンジ承認などの更新処理 |
| `verify_firebase_token`                    | Firebase UID の取得            |

---

### **⑥ テスト観点（エンドポイント`/api/payments`）**

- Stripe セッション URL を返す

### **テストケース**

- チェックアウトセッション生成 API `/api/payments/create-checkout-session`（POST）

| テスト ID  | テストケース名                             | 前提条件                                                     | テスト手順                                                                                                           | 期待結果                                                                                          |
| ---------- | ------------------------------------------ | ------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------- |
| TC-PAY-001 | 無料ユーザーがセッション URL を取得できる  | Firebase UID に対応するユーザーが `current_plan = "free"`    | 1. Authorization 付きで `/api/payments/create-checkout-session` に POST2. Stripe サービスをモックしダミー URL を返す | ステータスコード `200`、レスポンスに `url: "https://dummy-stripe-session-url.com"` を含む         |
| TC-PAY-002 | すでにプレミアムユーザーはエラー           | Firebase UID に対応するユーザーが `current_plan = "premium"` | 1. Authorization 付きで `/api/payments/create-checkout-session` に POST                                              | ステータスコード `400`、`detail: "すでにプレミアムプランです"` を含む                             |
| TC-PAY-003 | Stripe サービス側の例外は 500 エラーになる | Stripe の `create_checkout_session` が例外を発生させる       | 1. Authorization 付きで `/api/payments/create-checkout-session` に POST2. Stripe の処理を例外でモック                | ステータスコード `500`、`detail` に `"決済セッション生成中にサーバーエラーが発生しました"` を含む |
| TC-PAY-004 | Prisma の DB エラーでも 500 を返す         | `users.find_unique` が例外を投げる                           | 1. Authorization 付きで `/api/payments/create-checkout-session` に POST2. Prisma を例外でモック                      | ステータスコード `500`、`detail` に `"決済セッション生成中にサーバーエラーが発生しました`         |

### 使用したモック

| モック対象                               | 説明                           |
| ---------------------------------------- | ------------------------------ |
| `prisma_client.users.find_unique`        | プラン情報取得のため           |
| `stripe_service.create_checkout_session` | Stripe Checkout セッション作成 |
| `verify_firebase_token`                  | Firebase UID の取得            |

---

### **⑦ テスト観点（エンドポイント`/api/webhook_events`）**

- Webhook イベントの受診、支払い済みテーブルの更新、ユーザーの`current_plan`更新

### **テストケース**

- Webhook イベントの受信 API `/api/webhook_events/`（POST）

| テスト ID      | テストケース名                                | 前提条件                                                       | テスト手順                                                                   | 期待結果                                                                                                          |
| -------------- | --------------------------------------------- | -------------------------------------------------------------- | ---------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------- |
| TC-WEBHOOK-001 | checkout.session.completed イベントを処理する | payload に `type: checkout.session.completed` が含まれる       | 1. JSON を `/api/webhook_events/` に POST2. `process_webhook_event` をモック | ステータスコード `200`、`Webhook eventを保存しました` を含むレスポンス、`process_webhook_event()` が 1 回呼ばれる |
| TC-WEBHOOK-002 | 他のイベントタイプは処理されない              | payload に `type: payment_intent.succeeded` など別タイプを指定 | 1. JSON を POST2. `process_webhook_event` をモック                           | ステータスコード `200`、DB には保存されるが処理関数は呼ばれない                                                   |
| TC-WEBHOOK-003 | DB 保存時の例外は 500 エラーを返す            | `webhook_events.create` が例外を発生させる                     | 1. POST で有効な JSON を送信                                                 | ステータスコード `500`、`Webhook processing failed` を含む                                                        |
| TC-WEBHOOK-004 | 無効な JSON は 500 エラーを返す               | JSON が不正                                                    | 1. JSON の構造が不正な文字列を送信                                           | ステータスコード `500`、`Webhook processing failed` を含む                                                        |

- Webhook イベントの一括処理 API `/api/webhook_events/process`（POST）

| テスト ID      | テストケース名                               | 前提条件                                             | テスト手順                                          | 期待結果                                                               |
| -------------- | -------------------------------------------- | ---------------------------------------------------- | --------------------------------------------------- | ---------------------------------------------------------------------- |
| TC-WEBHOOK-005 | 未処理イベントを処理し、payment に登録する   | 未処理の `checkout.session.completed` イベントが存在 | 1. モックで該当イベントを返す 2. `/process` に POST | ステータスコード `200`、`1 件のイベントを処理して...` を含むレスポンス |
| TC-WEBHOOK-006 | 未処理イベントが存在しない場合は空レスポンス | イベントが 0 件                                      | 1. find_many の戻り値を空リストにモック             | ステータスコード `200`、`未処理のWebhookイベントはありません` を返す   |
| TC-WEBHOOK-007 | find_many で DB 例外が発生すると 500 エラー  | find_many が例外を発生させる                         | 1. 例外をモック                                     | ステータスコード `500`、`Webhook event processing failed` を含む       |
| TC-WEBHOOK-008 | 中間処理でエラーが発生した場合も 500 エラー  | payment.create などが例外を発生                      | 1. 中間処理を例外でモック                           | ステータスコード `500`、`Webhook event processing failed` を含む       |

- Webhook イベント処理関数 `process_webhook_event()`（単体テスト）

| テスト ID      | テストケース名                               | 前提条件                           | テスト手順                          | 期待結果                                                             |
| -------------- | -------------------------------------------- | ---------------------------------- | ----------------------------------- | -------------------------------------------------------------------- |
| TC-WEBHOOK-009 | payload が文字列でも処理できる               | `payload` が JSON 文字列形式       | 1. モックイベントを引数に関数を実行 | payment.create / users.update / update(processed: True) が実行される |
| TC-WEBHOOK-010 | payload が dict 形式でも処理できる           | `payload` が辞書形式               | 1. モックイベントを引数に関数を実行 | 上記と同様に DB 書き込みが行われる                                   |
| TC-WEBHOOK-011 | DB 処理中の例外は error_message に保存される | payment.create で例外が発生        | 1. モックイベントを引数に関数を実行 | `webhook_events.update` に `error_message` が記録される              |
| TC-WEBHOOK-012 | stripe_session_id がない場合はスキップ       | payload に `id` が存在しない       | 1. モックイベントを引数に関数を実行 | DB 更新は実行されない（skip）                                        |
| TC-WEBHOOK-013 | firebase_uid が None ならスキップ            | event.firebase_uid が None         | 同上                                | 処理されずスキップされる                                             |
| TC-WEBHOOK-014 | ユーザーが見つからない場合もスキップ         | `users.find_unique` が None を返す | 同上                                | スキップされる                                                       |

### 使用したモック

- `/api/webhook_events/`（POST）

| モック対象                                         | 説明                                                          |
| -------------------------------------------------- | ------------------------------------------------------------- |
| `prisma_client.webhook_events.create`              | イベントの受信保存                                            |
| `app.routers.webhook_events.process_webhook_event` | `checkout.session.completed` の場合に呼び出される自動処理関数 |

- `/api/webhook_events/process`（POST）

| モック対象                               | 説明                                   |
| ---------------------------------------- | -------------------------------------- |
| `prisma_client.webhook_events.find_many` | 未処理イベントの取得                   |
| `prisma_client.users.find_unique`        | 対応ユーザー取得                       |
| `prisma_client.payment.create`           | payment テーブルへの保存               |
| `prisma_client.users.update`             | プラン状態の更新                       |
| `prisma_client.webhook_events.update`    | processed フラグ、エラーメッセージ保存 |

- `process_webhook_event(event)`（関数）

| モック対象                            | 説明                              |
| ------------------------------------- | --------------------------------- |
| `prisma_client.users.find_unique`     | イベントに紐づくユーザー取得      |
| `prisma_client.payment.create`        | payment レコードの保存            |
| `prisma_client.users.update`          | プレミアムプランへ更新            |
| `prisma_client.webhook_events.update` | processed や error_message を更新 |

---

### テストコマンド

- バックエンド単体テスト実行

```bash
pytest tests/unit
```

- バックエンド単体テストカバレッジ率実行

```bash
pytest tests/unit --cov=app
```

---

### **対象ファイル別カバレッジ詳細**

以下は、主要ファイルのカバレッジ状況です。各ファイルのカバレッジ率が記載されています。

| ファイルパス                      | ステートメント数 | 未実行ステートメント | カバレッジ率 |
| --------------------------------- | ---------------- | -------------------- | ------------ |
| `app/__init__.py`                 | 0                | 0                    | 100%         |
| `app/config.py`                   | 0                | 0                    | 100%         |
| `app/db.py`                       | 2                | 0                    | 100%         |
| `app/dependencies.py`             | 25               | 11                   | **56%**      |
| `app/main.py`                     | 32               | 4                    | 88%          |
| `app/routers/__init__.py`         | 0                | 0                    | 100%         |
| `app/routers/care_logs.py`        | 106              | 17                   | 84%          |
| `app/routers/care_settings.py`    | 49               | 3                    | 94%          |
| `app/routers/message_logs.py`     | 40               | 4                    | 90%          |
| `app/routers/payment.py`          | 20               | 0                    | 100%         |
| `app/routers/reflection_notes.py` | 60               | 0                    | 100%         |
| `app/routers/user.py`             | 28               | 4                    | 86%          |
| `app/routers/webhook_events.py`   | 101              | 10                   | 90%          |
| `app/schemas/__init__.py`         | 0                | 0                    | 100%         |
| `app/schemas/care_logs.py`        | 30               | 0                    | 100%         |
| `app/schemas/care_settings.py`    | 49               | 0                    | 100%         |
| `app/schemas/reflection_notes.py` | 16               | 0                    | 100%         |
| `app/schemas/user.py`             | 27               | 0                    | 100%         |
| `app/services/stripe_service.py`  | 8                | 2                    | 75%          |
| **合計**                          | **593**          | **55**               | **91%**      |

---
