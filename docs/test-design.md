# テスト設計書

## 概要・目的

このテスト設計書は、犬のお世話体験アプリ「わん 🐾 みっしょん」の各機能において、バックエンド・フロントエンド・外部サービス（Firebase, Stripe 等）が正しく連携し、ユーザーに対して想定通りの体験を提供できるかを検証するための詳細なテスト項目を記載したものである。

本書では、バックエンドとフロントエンドの単体テストおよび統合テストを対象にし、ミッション機能の基本的な動作確認を目的とする。

## テスト方針

本テスト設計書では、以下の方針に基づいてテストケースを設計する。

- **想定ユーザーの行動（ユースケース）**に基づき、主に「保護者による初期設定」「お世話記録」「犬からのメッセージ生成」「反省文の投稿・承認」などの一連の利用フローをカバーする。
- **クリティカルパス**として、「お世話記録ができる」「PIN で認証ができる」「プレミアム決済が成功する」といった**アプリのコア体験を阻害しないこと**に焦点を当て、関連機能を重点的にテストする。
- **優先順位の高い機能**（ユーザー登録、認証、記録保存、メッセージ生成、Stripe 決済等）は異常系まで網羅し、**エラー時の復旧性**や**モックによる外部依存の分離**も含めて設計している。

また、今後フロントエンドや統合テストを拡充する際も、上記の流れに基づいた利用者視点の設計方針を維持する。

## 目標カバレッジ率：80％

目標カバレッジ率は、品質と工数のバランスを考慮し 80％とする。業界でも広く採用されている基準であり、主要なビジネスロジックを網羅しつつ、過剰なコストを避ける現実的な目標値として設定。

## **バックエンド**

バックエンドに関して単体テスト・統合テストを実施する。

## **テスト対象 1：単体テスト**

### **① テスト観点（エンドポイント`/api/users`）**

- ユーザー新規登録・ログインユーザー情報取得

### **テストケース**

- ユーザー新規登録 API `/api/users` （POST）

| テスト ID   | テストケース名                 | 前提条件                           | テスト手順                                                                                                    | 期待結果                                                           |
| ----------- | ------------------------------ | ---------------------------------- | ------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------ |
| TC-USER-001 | ユーザー新規登録が成功する     | 対象の Firebase UID は未登録       | 1. `firebase_uid`, `email`, `current_plan`, `is_verified` を含む JSON を POST2. `/api/users` にリクエスト送信 | ステータスコード `201`レスポンスに登録されたユーザー情報が含まれる |
| TC-USER-002 | 登録済みユーザーの登録はエラー | 対象の Firebase UID が既に存在する | 1. 同じ `firebase_uid` で `/api/users` に POST リクエスト                                                     | ステータスコード `409detail` に `"User already ex`                 |

- ログインユーザー情報取得 `/api/users/me` （GET）

| テスト ID   | テストケース名                       | 前提条件                                      | テスト手順                                                                  | 期待結果                                                                         |
| ----------- | ------------------------------------ | --------------------------------------------- | --------------------------------------------------------------------------- | -------------------------------------------------------------------------------- |
| TC-USER-003 | ログイン中ユーザー情報を取得できる   | `firebase_uid` に該当するユーザーが存在する   | 1. Authorization ヘッダーにトークン付きで `/api/users/me` に GET リクエスト | ステータスコード `200`レスポンスに `email`, `current_plan`, `is_verified` を含む |
| TC-USER-004 | 存在しないユーザー情報は取得できない | `firebase_uid` に該当するユーザーが存在しない | 1. Authorization ヘッダーにトークン付きで `/api/users/me` に GET リクエスト | ステータスコード `404detail` に `"User not found"` を含む                        |

### 使用したモック

| モック対象                        | 説明                   |
| --------------------------------- | ---------------------- |
| `prisma_client.users.find_unique` | ユーザーの存在チェック |
| `prisma_client.users.create`      | 新規登録時に使用       |
| `verify_firebase_token`           | Firebase UID の取得    |

---

### **② テスト観点（エンドポイント`/api/care_settings`）**

- お世話設定の登録・取得・4 ケタ PIN の照合

### **テストケース**

- お世話設定の登録 API `/api/care_settings` （POST）

| テスト ID   | テストケース名                                | 前提条件                                    | テスト手順                                                                           | 期待結果                                                                                |
| ----------- | --------------------------------------------- | ------------------------------------------- | ------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------- |
| TC-CARE-001 | お世話設定が正常に登録できる                  | Firebase UID に該当するユーザーが存在する   | 1. Authorization 付きで、必要なフィールドを含む JSON を `/api/care_settings` に POST | ステータスコード `201`、レスポンスに登録内容が含まれる                                  |
| TC-CARE-002 | ユーザーが存在しない場合はエラーになる        | Firebase UID に該当するユーザーが存在しない | 1. Authorization 付きで `/api/care_settings` に POST                                 | ステータスコード `404`、`detail` に `"User not found"` を含む                           |
| TC-CARE-003 | サーバー側でエラーが発生した場合は 500 になる | ユーザーは存在するが DB 操作時に例外発生    | 1. Authorization 付きで `/api/care_settings` に POST                                 | ステータスコード `500`、`detail` に `"お世話設定の登録中にエラーが発生しました"` を含む |

- お世話設定の取得 API `/api/care_settings/me`（GET）

| テスト ID   | テストケース名                             | 前提条件                                                 | テスト手順                                                                | 期待結果                                                              |
| ----------- | ------------------------------------------ | -------------------------------------------------------- | ------------------------------------------------------------------------- | --------------------------------------------------------------------- |
| TC-CARE-004 | お世話設定を正常に取得できる               | Firebase UID に対応するユーザーと CareSetting が存在する | 1. Authorization ヘッダー付きで `/api/care_settings/me` に GET リクエスト | ステータスコード `200`、レスポンスにお世話設定情報が含まれる          |
| TC-CARE-005 | ユーザーが存在しない場合は取得できない     | Firebase UID に対応するユーザーが存在しない              | 1. Authorization ヘッダー付きで `/api/care_settings/me` に GET リクエスト | ステータスコード `404`、`detail` に `"User not found"` を含む         |
| TC-CARE-006 | CareSetting が存在しない場合は取得できない | ユーザーは存在するが CareSetting が存在しない            | 1. Authorization ヘッダー付きで `/api/care_settings/me` に GET リクエスト | ステータスコード `404`、`detail` に `"Care setting not found"` を含む |

- PIN 認証 API `/api/care_settings/verify_pin`（POST）

| テスト ID   | テストケース名                   | 前提条件                                         | テスト手順                                             | 期待結果                                                                       |
| ----------- | -------------------------------- | ------------------------------------------------ | ------------------------------------------------------ | ------------------------------------------------------------------------------ |
| TC-CARE-007 | PIN 認証が成功する               | ユーザーが存在し、登録済み PIN と入力 PIN が一致 | 1. Authorization 付きで `input_password` を POST       | ステータスコード `200`、`verified: true` を返す                                |
| TC-CARE-008 | PIN が一致しない場合は失敗する   | ユーザーが存在し、PIN が一致しない               | 1. Authorization 付きで異なる `input_password` を POST | ステータスコード `200`、`verified: false` を返す                               |
| TC-CARE-009 | ユーザーが存在しない場合はエラー | Firebase UID に対応するユーザーが存在しない      | 1. Authorization 付きで `input_password` を POST       | ステータスコード `404`、`detail` に `"User not found"` を含む                  |
| TC-CARE-010 | サーバーエラー時は 500 を返す    | care_settings.find_first 実行時に例外発生        | 1. Authorization 付きで `input_password` を POST       | ステータスコード `500`、`detail` に `"PIN認証中にエラーが発生しました"` を含む |

### 使用したモック

| モック対象                               | 説明                     |
| ---------------------------------------- | ------------------------ |
| `prisma_client.users.find_unique`        | ユーザーの存在チェック   |
| `prisma_client.care_settings.find_first` | ユーザーの既存設定取得   |
| `prisma_client.care_settings.create`     | 新規作成                 |
| `prisma_client.care_settings.update`     | 編集・PIN 検証・状態更新 |
| `verify_firebase_token`                  | Firebase UID の取得      |

---

### **③ テスト観点（エンドポイント`/api/care_logs`）**

- 1 日 1 件のお世話記録の登録・更新・一覧

### **テストケース**

- お世話記録の登録 API `/api/care_logs` （POST）

| テスト ID  | テストケース名                       | 前提条件                                                                      | テスト手順                                                             | 期待結果                                                                      |
| ---------- | ------------------------------------ | ----------------------------------------------------------------------------- | ---------------------------------------------------------------------- | ----------------------------------------------------------------------------- |
| TC-LOG-001 | お世話記録が正常に登録できる         | Firebase UID に該当するユーザーと care_setting が存在し、該当日の記録が未登録 | 1. Authorization 付きで、care_log の JSON を `/api/care_logs` に POST  | ステータスコード `201`、登録された care_log 情報を返す                        |
| TC-LOG-002 | 同じ日付の記録が既にある場合はエラー | 同日付の care_log が既に存在する                                              | 1. Authorization 付きで同じ日付の care_log を `/api/care_logs` に POST | ステータスコード `400`、`detail` に `"この日付の記録は既に存在します"` を含む |

- お世話記録の更新 API `/api/care_logs/{care_log_id}`（PATCH）

| テスト ID  | テストケース名                        | 前提条件                         | テスト手順                                                                        | 期待結果                                                          |
| ---------- | ------------------------------------- | -------------------------------- | --------------------------------------------------------------------------------- | ----------------------------------------------------------------- |
| TC-LOG-003 | お世話記録を正常に更新できる          | 指定した care_log ID が存在する  | 1. Authorization 付きで更新フィールドを含む JSON を `/api/care_logs/123` に PATCH | ステータスコード `200`、更新後の care_log 情報を返す              |
| TC-LOG-004 | 存在しない care_log ID の場合はエラー | 指定 ID の care_log が存在しない | 1. Authorization 付きで `/api/care_logs/999` に PATCH                             | ステータスコード `404`、`detail` に `"Care log not found"` を含む |

- 当日の記録取得 API `/api/care_logs/today`（GET）

| テスト ID  | テストケース名                                | 前提条件                                            | テスト手順                                                                                | 期待結果                                                                           |
| ---------- | --------------------------------------------- | --------------------------------------------------- | ----------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------- |
| TC-LOG-005 | 当日の記録を正常に取得できる                  | care_setting が本人のもので、当日の記録が存在する   | 1. Authorization 付きで `care_setting_id` と `date` を指定して GET `/api/care_logs/today` | ステータスコード `200`、当日の care_log 情報を返す                                 |
| TC-LOG-006 | 当日の記録が存在しない場合は初期値を返す      | care_setting が本人のもので、当日の記録が存在しない | 1. 同上                                                                                   | ステータスコード `200`、`care_log_id: null`、`fed_morning: false` 等の初期値を返す |
| TC-LOG-007 | 他人の care_setting_id を指定した場合はエラー | Firebase UID と care_setting_id が一致しない        | 1. 不正な `care_setting_id` で `/api/care_logs/today` に GET                              | ステータスコード `403`、`detail` に `"不正な care_setting_id です"` を含む         |

- 日付指定記録取得 API `/api/care_logs/by_date`（GET）

| テスト ID  | テストケース名                                | 前提条件                                              | テスト手順                                                                                  | 期待結果                                                                           |
| ---------- | --------------------------------------------- | ----------------------------------------------------- | ------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------- |
| TC-LOG-008 | 指定日のお世話記録を取得できる                | care_setting が本人のもので、該当日の記録が存在する   | 1. Authorization 付きで `care_setting_id` と `date` を指定して GET `/api/care_logs/by_date` | ステータスコード `200`、指定日の care_log 情報を返す                               |
| TC-LOG-009 | 指定日の記録が存在しない場合は初期値を返す    | care_setting が本人のもので、該当日の記録が存在しない | 1. 同上                                                                                     | ステータスコード `200`、`care_log_id: null`、`fed_morning: false` 等の初期値を返す |
| TC-LOG-010 | 他人の care_setting_id を指定した場合はエラー | Firebase UID と care_setting_id が一致しない          | 1. 不正な `care_setting_id` で `/api/care_logs/by_date` に GET                              | ステータスコード `403`、`detail` に `"不正な care_setting_id です"` を含む         |

- 記録一覧取得 API `/api/care_logs/list`（GET）

| テスト ID  | テストケース名                                | 前提条件                                            | テスト手順                                                                     | 期待結果                                                                   |
| ---------- | --------------------------------------------- | --------------------------------------------------- | ------------------------------------------------------------------------------ | -------------------------------------------------------------------------- |
| TC-LOG-011 | care_log を複数件取得できる                   | care_setting が本人のもので、複数件の記録が存在する | 1. Authorization 付きで `care_setting_id` を指定して GET `/api/care_logs/list` | ステータスコード `200`、`care_logs` 配列に記録一覧を返す                   |
| TC-LOG-012 | 記録が 0 件でも空配列を返す                   | care_setting が本人のもので、記録が存在しない       | 1. 同上                                                                        | ステータスコード `200`、空の `care_logs` 配列を返す                        |
| TC-LOG-013 | 他人の care_setting_id を指定した場合はエラー | Firebase UID と care_setting_id が一致しない        | 1. 不正な `care_setting_id` で `/api/care_logs/list` に GET                    | ステータスコード `403`、`detail` に `"不正な care_setting_id です"` を含む |

### 使用したモック

| モック対象                           | 説明                       |
| ------------------------------------ | -------------------------- |
| `prisma_client.users.find_unique`    | ユーザーの存在チェック     |
| `prisma_client.care_logs.find_first` | 同一日付のログ存在確認など |
| `prisma_client.care_logs.create`     | お世話ログの新規作成       |
| `prisma_client.care_logs.update`     | 状態変更や振り返り文の保存 |
| `prisma_client.care_logs.find_many`  | ログの一覧・日付取得など   |
| `verify_firebase_token`              | Firebase UID の取得        |

---

### **④ テスト観点（エンドポイント`/api/message_logs`）**

- 犬のひとことの生成・OpenAI メッセージ取得

### **テストケース**

- メッセージ生成 API `/api/message_logs/generate`（POST）

| テスト ID  | テストケース名                                         | 前提条件                                    | テスト手順                                                                                                | 期待結果                                                                        |
| ---------- | ------------------------------------------------------ | ------------------------------------------- | --------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------- |
| TC-MSG-001 | 無料プランユーザーは固定メッセージを受け取る           | ユーザーが `free` プラン                    | 1. Authorization 付きで `/api/message_logs/generate` に POST2. `random.choice` を固定で「わん！」にモック | ステータスコード `200`、`message: "わん！"` を返す                              |
| TC-MSG-002 | プレミアムプランユーザーは AI 生成メッセージを受け取る | ユーザーが `premium` プラン                 | 1. `get_openai_message` を `"おべんきょうするわん！"` にモック 2. POST リクエスト送信                     | ステータスコード `200`、`message: "おべんきょうするわん！"` を返す              |
| TC-MSG-003 | プレミアムプランだが OpenAI エラー時は固定メッセージ   | `get_openai_message` が例外を発生           | 1. `get_openai_message` を例外に 2. `random.choice` を「わん！」にモック                                  | ステータスコード `200`、`message: "わん！"` を返す                              |
| TC-MSG-004 | ユーザーが存在しない場合は 400 エラー                  | Firebase UID に対応するユーザーが存在しない | 1. `users.find_unique` を `None` にモック 2. POST リクエスト送信                                          | ステータスコード `400`、`detail: "Firebase UIDのユーザーが存在しません"` を含む |
| TC-MSG-005 | DB エラー時もフォールバックメッセージを返す            | `users.find_unique` が例外を発生            | 1. `users.find_unique` を例外に 2. `random.choice` を「わん！」にモック                                   | ステータスコード `200`、`message: "わん！」` を返す                             |

- OpenAI メッセージ取得関数 `get_openai_message`（ユニットテスト）

| テスト ID  | テストケース名                                    | 前提条件                               | テスト手順                                                                                 | 期待結果                                            |
| ---------- | ------------------------------------------------- | -------------------------------------- | ------------------------------------------------------------------------------------------ | --------------------------------------------------- |
| TC-MSG-006 | OpenAI が空レスポンスを返した場合は固定メッセージ | `choices[0].message.content` が `None` | 1. OpenAI クライアントをモックして空レスポンスを再現 2. `random.choice` を「わん！」に固定 | `get_openai_message()` の戻り値が `"わん！"` になる |

### 使用したモック

| モック対象                             | 説明                      |
| -------------------------------------- | ------------------------- |
| `prisma_client.users.find_unique`      | ユーザー存在チェック      |
| `prisma_client.message_logs.create`    | メッセージ保存（POST）    |
| `prisma_client.message_logs.find_many` | メッセージ一覧取得（GET） |
| `verify_firebase_token`                | Firebase UID の取得       |

---

### **⑤ テスト観点（エンドポイント`/api/reflection_notes`）**

- 反省文の登録・取得・承認

### **テストケース**

- 反省文の新規登録 API `/api/reflection_notes`（POST）

| テスト ID      | テストケース名                                    | 前提条件                                        | テスト手順                                                                       | 期待結果                                                                      |
| -------------- | ------------------------------------------------- | ----------------------------------------------- | -------------------------------------------------------------------------------- | ----------------------------------------------------------------------------- |
| TC-REFLECT-001 | 反省文を正常に登録できる                          | ユーザーと care_setting が存在する              | 1. Authorization 付きで `content` を含む JSON を `/api/reflection_notes` に POST | ステータスコード `201`、レスポンスに登録内容が含まれる                        |
| TC-REFLECT-002 | ユーザーが存在しない場合は 404 エラー             | Firebase UID に該当するユーザーが存在しない     | 1. Authorization 付きで POST                                                     | ステータスコード `404`、`detail` に `"ユーザーが見つかりません"` を含む       |
| TC-REFLECT-003 | care_setting が存在しない場合は 404 エラー        | ユーザーは存在するが、care_setting が存在しない | 1. Authorization 付きで POST                                                     | ステータスコード `404`、`detail` に `"お世話設定が見つかりません"` を含む     |
| TC-REFLECT-004 | 登録時にサーバーエラーが発生した場合は 500 エラー | Prisma の create 操作で例外発生                 | 1. Authorization 付きで POST                                                     | ステータスコード `500`、`detail` に `"DB登録時にエラーが発生しました"` を含む |

- 反省文の取得 API `/api/reflection_notes`（GET）

| テスト ID      | テストケース名                             | 前提条件                                                 | テスト手順                                             | 期待結果                                                                      |
| -------------- | ------------------------------------------ | -------------------------------------------------------- | ------------------------------------------------------ | ----------------------------------------------------------------------------- |
| TC-REFLECT-005 | 登録済みの反省文一覧を取得できる           | ユーザーと care_setting が存在し、反省文が 1 件以上存在  | 1. Authorization 付きで `/api/reflection_notes` に GET | ステータスコード `200`、反省文のリストを返す                                  |
| TC-REFLECT-006 | 反省文が 0 件でも空リストを返す            | ユーザーと care_setting は存在するが、反省文が存在しない | 1. Authorization 付きで GET                            | ステータスコード `200`、空配列 `[]` を返す                                    |
| TC-REFLECT-007 | ユーザーが存在しない場合は 404 エラー      | Firebase UID に対応するユーザーが存在しない              | 1. Authorization 付きで GET                            | ステータスコード `404`、`detail` に `"ユーザーが見つかりません"` を含む       |
| TC-REFLECT-008 | care_setting が存在しない場合は 404 エラー | ユーザーは存在するが、care_setting が存在しない          | 1. Authorization 付きで GET                            | ステータスコード `404`、`detail` に `"お世話設定が見つかりません"` を含む     |
| TC-REFLECT-009 | サーバーエラーが発生した場合は 500 エラー  | Prisma の操作で例外発生                                  | 1. Authorization 付きで GET                            | ステータスコード `500`、`detail` に `"DB取得時にエラーが発生しました"` を含む |

- 反省文の承認状態更新 API `/api/reflection_notes/{note_id}`（PATCH）

| テスト ID      | テストケース名                                        | 前提条件                                                   | テスト手順                                                  | 期待結果                                                      |
| -------------- | ----------------------------------------------------- | ---------------------------------------------------------- | ----------------------------------------------------------- | ------------------------------------------------------------- |
| TC-REFLECT-010 | 保護者が反省文の承認状態を更新できる                  | ユーザーと care_setting が存在し、対象 note が紐づいている | 1. Authorization 付きで `approved_by_parent: true` を PATCH | ステータスコード `200`、更新された note 情報を返す            |
| TC-REFLECT-011 | ユーザーが存在しない場合は 404 エラー                 | Firebase UID に対応するユーザーが存在しない                | 1. Authorization 付きで PATCH                               | ステータスコード `404`、`"ユーザーが見つかりません"` を含む   |
| TC-REFLECT-012 | care_setting が存在しない場合は 404 エラー            | ユーザーは存在するが care_setting が存在しない             | 1. Authorization 付きで PATCH                               | ステータスコード `404`、`"お世話設定が見つかりません"` を含む |
| TC-REFLECT-013 | 対象の note が存在しない場合は 403 エラー             | 指定 note が見つからない                                   | 1. Authorization 付きで PATCH                               | ステータスコード `403`、`"アクセスする権限"` を含む           |
| TC-REFLECT-014 | note の care_setting_id が一致しない場合は 403 エラー | note の care_setting_id が本人のものと異なる               | 1. Authorization 付きで PATCH                               | ステータスコード `403`、`"アクセスする権限"` を含む           |
| TC-REFLECT-015 | サーバーエラーが発生した場合は 500 エラー             | Prisma 操作中に例外発生                                    | 1. Authorization 付きで PATCH                               | ステータスコード `500`、`"反省文の更新中にエラー"` を含む     |

### 使用したモック

| モック対象                                 | 説明                           |
| ------------------------------------------ | ------------------------------ |
| `prisma_client.users.find_unique`          | ユーザー存在チェック           |
| `prisma_client.reflection_notes.create`    | ノートの新規作成               |
| `prisma_client.reflection_notes.find_many` | ノートの取得（一覧）           |
| `prisma_client.reflection_notes.update`    | 再チャレンジ承認などの更新処理 |
| `verify_firebase_token`                    | Firebase UID の取得            |

---

### **⑥ テスト観点（エンドポイント`/api/payments`）**

- Stripe セッション URL を返す

### **テストケース**

- チェックアウトセッション生成 API `/api/payments/create-checkout-session`（POST）

| テスト ID  | テストケース名                             | 前提条件                                                     | テスト手順                                                                                                           | 期待結果                                                                                          |
| ---------- | ------------------------------------------ | ------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------- |
| TC-PAY-001 | 無料ユーザーがセッション URL を取得できる  | Firebase UID に対応するユーザーが `current_plan = "free"`    | 1. Authorization 付きで `/api/payments/create-checkout-session` に POST2. Stripe サービスをモックしダミー URL を返す | ステータスコード `200`、レスポンスに `url: "https://dummy-stripe-session-url.com"` を含む         |
| TC-PAY-002 | すでにプレミアムユーザーはエラー           | Firebase UID に対応するユーザーが `current_plan = "premium"` | 1. Authorization 付きで `/api/payments/create-checkout-session` に POST                                              | ステータスコード `400`、`detail: "すでにプレミアムプランです"` を含む                             |
| TC-PAY-003 | Stripe サービス側の例外は 500 エラーになる | Stripe の `create_checkout_session` が例外を発生させる       | 1. Authorization 付きで `/api/payments/create-checkout-session` に POST2. Stripe の処理を例外でモック                | ステータスコード `500`、`detail` に `"決済セッション生成中にサーバーエラーが発生しました"` を含む |
| TC-PAY-004 | Prisma の DB エラーでも 500 を返す         | `users.find_unique` が例外を投げる                           | 1. Authorization 付きで `/api/payments/create-checkout-session` に POST2. Prisma を例外でモック                      | ステータスコード `500`、`detail` に `"決済セッション生成中にサーバーエラーが発生しました`         |

### 使用したモック

| モック対象                               | 説明                           |
| ---------------------------------------- | ------------------------------ |
| `prisma_client.users.find_unique`        | プラン情報取得のため           |
| `stripe_service.create_checkout_session` | Stripe Checkout セッション作成 |
| `verify_firebase_token`                  | Firebase UID の取得            |

---

### **⑦ テスト観点（エンドポイント`/api/webhook_events`）**

- Webhook イベントの受診、支払い済みテーブルの更新、ユーザーの`current_plan`更新

### **テストケース**

- Webhook イベントの受信 API `/api/webhook_events/`（POST）

| テスト ID      | テストケース名                                | 前提条件                                                       | テスト手順                                                                   | 期待結果                                                                                                          |
| -------------- | --------------------------------------------- | -------------------------------------------------------------- | ---------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------- |
| TC-WEBHOOK-001 | checkout.session.completed イベントを処理する | payload に `type: checkout.session.completed` が含まれる       | 1. JSON を `/api/webhook_events/` に POST2. `process_webhook_event` をモック | ステータスコード `200`、`Webhook eventを保存しました` を含むレスポンス、`process_webhook_event()` が 1 回呼ばれる |
| TC-WEBHOOK-002 | 他のイベントタイプは処理されない              | payload に `type: payment_intent.succeeded` など別タイプを指定 | 1. JSON を POST2. `process_webhook_event` をモック                           | ステータスコード `200`、DB には保存されるが処理関数は呼ばれない                                                   |
| TC-WEBHOOK-003 | DB 保存時の例外は 500 エラーを返す            | `webhook_events.create` が例外を発生させる                     | 1. POST で有効な JSON を送信                                                 | ステータスコード `500`、`Webhook processing failed` を含む                                                        |
| TC-WEBHOOK-004 | 無効な JSON は 500 エラーを返す               | JSON が不正                                                    | 1. JSON の構造が不正な文字列を送信                                           | ステータスコード `500`、`Webhook processing failed` を含む                                                        |

- Webhook イベントの一括処理 API `/api/webhook_events/process`（POST）

| テスト ID      | テストケース名                               | 前提条件                                             | テスト手順                                          | 期待結果                                                               |
| -------------- | -------------------------------------------- | ---------------------------------------------------- | --------------------------------------------------- | ---------------------------------------------------------------------- |
| TC-WEBHOOK-005 | 未処理イベントを処理し、payment に登録する   | 未処理の `checkout.session.completed` イベントが存在 | 1. モックで該当イベントを返す 2. `/process` に POST | ステータスコード `200`、`1 件のイベントを処理して...` を含むレスポンス |
| TC-WEBHOOK-006 | 未処理イベントが存在しない場合は空レスポンス | イベントが 0 件                                      | 1. find_many の戻り値を空リストにモック             | ステータスコード `200`、`未処理のWebhookイベントはありません` を返す   |
| TC-WEBHOOK-007 | find_many で DB 例外が発生すると 500 エラー  | find_many が例外を発生させる                         | 1. 例外をモック                                     | ステータスコード `500`、`Webhook event processing failed` を含む       |
| TC-WEBHOOK-008 | 中間処理でエラーが発生した場合も 500 エラー  | payment.create などが例外を発生                      | 1. 中間処理を例外でモック                           | ステータスコード `500`、`Webhook event processing failed` を含む       |

- Webhook イベント処理関数 `process_webhook_event()`（単体テスト）

| テスト ID      | テストケース名                               | 前提条件                           | テスト手順                          | 期待結果                                                             |
| -------------- | -------------------------------------------- | ---------------------------------- | ----------------------------------- | -------------------------------------------------------------------- |
| TC-WEBHOOK-009 | payload が文字列でも処理できる               | `payload` が JSON 文字列形式       | 1. モックイベントを引数に関数を実行 | payment.create / users.update / update(processed: True) が実行される |
| TC-WEBHOOK-010 | payload が dict 形式でも処理できる           | `payload` が辞書形式               | 1. モックイベントを引数に関数を実行 | 上記と同様に DB 書き込みが行われる                                   |
| TC-WEBHOOK-011 | DB 処理中の例外は error_message に保存される | payment.create で例外が発生        | 1. モックイベントを引数に関数を実行 | `webhook_events.update` に `error_message` が記録される              |
| TC-WEBHOOK-012 | stripe_session_id がない場合はスキップ       | payload に `id` が存在しない       | 1. モックイベントを引数に関数を実行 | DB 更新は実行されない（skip）                                        |
| TC-WEBHOOK-013 | firebase_uid が None ならスキップ            | event.firebase_uid が None         | 同上                                | 処理されずスキップされる                                             |
| TC-WEBHOOK-014 | ユーザーが見つからない場合もスキップ         | `users.find_unique` が None を返す | 同上                                | スキップされる                                                       |

### 使用したモック

- `/api/webhook_events/`（POST）

| モック対象                                         | 説明                                                          |
| -------------------------------------------------- | ------------------------------------------------------------- |
| `prisma_client.webhook_events.create`              | イベントの受信保存                                            |
| `app.routers.webhook_events.process_webhook_event` | `checkout.session.completed` の場合に呼び出される自動処理関数 |

- `/api/webhook_events/process`（POST）

| モック対象                               | 説明                                   |
| ---------------------------------------- | -------------------------------------- |
| `prisma_client.webhook_events.find_many` | 未処理イベントの取得                   |
| `prisma_client.users.find_unique`        | 対応ユーザー取得                       |
| `prisma_client.payment.create`           | payment テーブルへの保存               |
| `prisma_client.users.update`             | プラン状態の更新                       |
| `prisma_client.webhook_events.update`    | processed フラグ、エラーメッセージ保存 |

- `process_webhook_event(event)`（関数）

| モック対象                            | 説明                              |
| ------------------------------------- | --------------------------------- |
| `prisma_client.users.find_unique`     | イベントに紐づくユーザー取得      |
| `prisma_client.payment.create`        | payment レコードの保存            |
| `prisma_client.users.update`          | プレミアムプランへ更新            |
| `prisma_client.webhook_events.update` | processed や error_message を更新 |

---

### テストコマンド

- バックエンド単体テスト実行

```bash
pytest tests/unit
```

- バックエンド単体テストカバレッジ率実行

```bash
pytest tests/unit --cov=app
```

---

### **対象ファイル別カバレッジ詳細**

以下は、主要ファイルのカバレッジ状況です。各ファイルのカバレッジ率が記載されています。

| ファイルパス                      | ステートメント数 | 未実行ステートメント | カバレッジ率 |
| --------------------------------- | ---------------- | -------------------- | ------------ |
| `app/__init__.py`                 | 0                | 0                    | 100%         |
| `app/config.py`                   | 0                | 0                    | 100%         |
| `app/db.py`                       | 2                | 0                    | 100%         |
| `app/dependencies.py`             | 25               | 11                   | **56%**      |
| `app/main.py`                     | 32               | 4                    | 88%          |
| `app/routers/__init__.py`         | 0                | 0                    | 100%         |
| `app/routers/care_logs.py`        | 106              | 17                   | 84%          |
| `app/routers/care_settings.py`    | 49               | 3                    | 94%          |
| `app/routers/message_logs.py`     | 40               | 4                    | 90%          |
| `app/routers/payment.py`          | 20               | 0                    | 100%         |
| `app/routers/reflection_notes.py` | 60               | 0                    | 100%         |
| `app/routers/user.py`             | 28               | 4                    | 86%          |
| `app/routers/webhook_events.py`   | 101              | 10                   | 90%          |
| `app/schemas/__init__.py`         | 0                | 0                    | 100%         |
| `app/schemas/care_logs.py`        | 30               | 0                    | 100%         |
| `app/schemas/care_settings.py`    | 49               | 0                    | 100%         |
| `app/schemas/reflection_notes.py` | 16               | 0                    | 100%         |
| `app/schemas/user.py`             | 27               | 0                    | 100%         |
| `app/services/stripe_service.py`  | 8                | 2                    | 75%          |
| **合計**                          | **593**          | **55**               | **91%**      |

---

## **テスト対象 2：統合テスト**

### **① テスト観点（データベース）**

### **テストケース**

| テスト ID  | テスト項目                               | 入力データ                                        | 期待結果                                                               |
| ---------- | ---------------------------------------- | ------------------------------------------------- | ---------------------------------------------------------------------- |
| INT-DB-001 | ユーザーとお世話設定のリレーション確認   | ユーザー・お世話設定作成                          | `user_id` に紐づいてリレーションが正しく取得できる                     |
| INT-DB-002 | お世話設定とお世話ログのリレーション確認 | お世話ログ 2 件登録                               | 関連ログが 2 件取得され、内容が一致する                                |
| INT-DB-003 | お世話設定と反省文のリレーション確認     | 反省文 1 件登録                                   | 関連反省文が取得され、内容が一致する                                   |
| INT-DB-004 | 決済情報とユーザーのリレーション確認     | 決済情報 1 件登録後、ユーザープラン更新           | `payment` とユーザーが紐づき、`current_plan` が `premium` に更新される |
| INT-DB-005 | カスケード削除動作確認                   | ユーザー・お世話設定・ログ・反省文を作成後に削除  | 全ての関連データが削除され、ユーザーも取得できない                     |
| INT-DB-006 | データ整合性制約の確認                   | 重複 Firebase UID・email・存在しない user_id 登録 | `Unique制約`や`外部キー制約`により例外が発生                           |
| INT-DB-007 | 日時データの取り扱い                     | 日時項目を含むお世話設定の作成                    | 各日時フィールドが正しく保存・取得される                               |
| INT-DB-008 | 複雑な JOIN クエリ結果の確認             | お世話設定に対して複数ログ・反省文を登録          | JOIN により、最新ログ 2 件・反省文が正しく取得される                   |

### **② テスト観点（DB リレーション）**

### **テストケース**

| テスト ID | テスト項目                                   | 対象機能                                          | 入力値                                                        | 期待結果                                                     | 備考                           |
| --------- | -------------------------------------------- | ------------------------------------------------- | ------------------------------------------------------------- | ------------------------------------------------------------ | ------------------------------ |
| DB-01     | ユーザーとお世話設定のリレーション確認       | users, care_settings                              | ユーザー・お世話設定を作成                                    | care_settings.user_id = user.id / include で関連付け確認     | リレーション確認               |
| DB-02     | お世話設定とログのリレーション確認           | care_settings, care_logs                          | care_logs を複数作成                                          | care_logs が 2 件取得でき、内容が一致                        | 日付でソートして内容検証       |
| DB-03     | お世話設定と反省文のリレーション確認         | care_settings, reflection_notes                   | 反省文を 1 件作成                                             | 紐づいた反省文が取得され、approved_by_parent: False である   | 反省文の正当なリレーション確認 |
| DB-04     | ユーザーと決済情報の関連付け                 | users, payment                                    | payment レコード作成                                          | payment.user_id = user.id / current_plan が "premium" に更新 | ユーザープラン更新含む         |
| DB-05     | カスケード削除の確認                         | users, care_settings, care_logs, reflection_notes | 関連データをすべて作成後に順に削除                            | 削除後、find_unique で None が返る                           | 手動削除による再現             |
| DB-06     | データ整合性制約の確認（ユニーク・外部キー） | users, care_settings                              | 重複 firebase_uid/email, 存在しない user_id を使用            | それぞれの操作で例外（Unique 制約/外部キー制約）             | pytest.raises(Exception)使用   |
| DB-07     | 日時情報の正しい保存・取得                   | care_settings                                     | care_start_date, meal_time, walk_time に ISO8601 文字列を入力 | すべての日時項目が正しく保存・取得されている                 | created_at も確認              |
| DB-08     | JOIN を含む複雑なクエリ検証                  | users → care_settings → care_logs                 | care_logs を 3 件作成し、take + order_by で JOIN 取得         | care_logs が 2 件取得され、最新の日付順であること            | JOIN とサブ項目制限の確認      |

### **③ テスト観点（API 統合フロー）**

### **テストケース**

| テスト ID   | テスト項目                   | 入力データ                                    | 期待結果                                      |
| ----------- | ---------------------------- | --------------------------------------------- | --------------------------------------------- |
| INT-API-001 | お世話ログ登録～取得         | お世話設定済み状態で、お世話ログ 1 件登録     | 登録成功（201）し、GET で同一ログが取得できる |
| INT-API-002 | 反省文登録～承認フロー       | 反省文を 1 件登録し、一覧取得 →PATCH で承認   | 登録・取得・更新すべて成功（200/201）         |
| INT-API-003 | ユーザー＋お世話設定の作成   | /users にユーザー登録 → /care_settings へ登録 | 両 API が成功し、GET で登録内容が確認できる   |
| INT-API-004 | PIN コード認証（成功・失敗） | 正しい PIN、誤った PIN をそれぞれ送信         | 成功時 true、失敗時 false が返る              |

---

### 統合テストにおける使用モック

Firebase 認証処理（verify_firebase_token）を FastAPI の依存関係オーバーライドによりモック。
外部の Firebase 認証サーバーを呼び出さず、テスト用の firebase_uid を返すようにしている。

---

### テストコマンド

- バックエンド単体テスト実行

```bash
pytest tests/integration
```

- バックエンド単体テストカバレッジ率実行

```bash
pytest tests/integration --cov=app
```

---

### **対象ファイル別カバレッジ詳細**

以下は、主要ファイルのカバレッジ状況です。各ファイルのカバレッジ率が記載されています。

| ファイルパス                      | ステートメント数 | 未カバー数 | カバレッジ | 未カバー行                                                         |
| --------------------------------- | ---------------- | ---------- | ---------- | ------------------------------------------------------------------ |
| `app/db.py`                       | 2                | 0          | 100%       | -                                                                  |
| `app/dependencies.py`             | 25               | 3          | 88%        | 18, 50–51                                                          |
| `app/main.py`                     | 39               | 6          | 85%        | 42–50, 80                                                          |
| `app/routers/__init__.py`         | 0                | 0          | 100%       | -                                                                  |
| `app/routers/care_logs.py`        | 112              | 47         | 58%        | 67–69, 96, 111–112, 140–142, 184–185, 201–203,<br>224–266, 285–323 |
| `app/routers/care_settings.py`    | 53               | 23         | 57%        | 47, 89–92, 108–144, 167, 173, 179                                  |
| `app/routers/message_logs.py`     | 40               | 11         | 72%        | 31, 69–77, 119–122                                                 |
| `app/routers/payment.py`          | 20               | 3          | 85%        | 52–54                                                              |
| `app/routers/reflection_notes.py` | 60               | 16         | 73%        | 40, 62–64, 84, 103–105, 128, 134, 138, 148–152                     |
| `app/routers/user.py`             | 28               | 4          | 86%        | 45–47, 72–73                                                       |
| `app/routers/webhook_events.py`   | 101              | 31         | 69%        | 68, 85, 141–146, 177, 180–236, 244                                 |
| `app/schemas/__init__.py`         | 0                | 0          | 100%       | -                                                                  |
| `app/schemas/care_logs.py`        | 30               | 0          | 100%       | -                                                                  |
| `app/schemas/care_settings.py`    | 49               | 0          | 100%       | -                                                                  |
| `app/schemas/reflection_notes.py` | 16               | 0          | 100%       | -                                                                  |
| `app/schemas/user.py`             | 27               | 0          | 100%       | -                                                                  |
| `app/services/stripe_service.py`  | 8                | 0          | 100%       | -                                                                  |
| **合計**                          | **610**          | **144**    | **76%**    | -                                                                  |

---

## **フロントエンド**

フロントエンドに関して単体テスト・統合テストを実施する。

- インストールコマンド

```jsx
npm install --save-dev @testing-library/react
```

## **テスト対象 1：単体テスト**

### ① テスト観点(`AdminPage` )

- `useCareSettings`  と  `useCareLogs`  の読み込み結果に応じて、画面が適切に分岐されるか
- 各表示状態（正常・エラー・ローディング・未登録・未記録）ごとに期待されるテキストが正しく表示されるか

### テストケース

| テスト ID       | テストケース名                                   | 前提条件                                          | テスト手順             | 期待結果                                                       |
| --------------- | ------------------------------------------------ | ------------------------------------------------- | ---------------------- | -------------------------------------------------------------- |
| TC-FE-ADMIN-001 | 正常時に目標カードが表示される                   | useCareSettings と useCareLogs が正常データを返す | `<AdminPage />` を描画 | 「さき達成中」「連続でお世話を達成」などのテキストが表示される |
| TC-FE-ADMIN-002 | useCareSettings がエラー時にエラーメッセージ表示 | `error: Error('fail')`                            | 描画後の画面を確認     | 「エラーが発生しました」が表示される                           |
| TC-FE-ADMIN-003 | ローディング中に読み込み中表示                   | `loading: true`                                   | 描画後の画面を確認     | 「読み込み中...」が表示される                                  |
| TC-FE-ADMIN-004 | child_name が空文字のときデータなし表示          | `child_name: ""`                                  | 描画後の画面を確認     | 「データがありません」が表示される                             |
| TC-FE-ADMIN-005 | care_log_id が null のとき未記録表示             | `care_log_id: null`                               | 描画後の画面を確認     | 「今日はまだお世話記録がありません」が表示される               |
|                 |                                                  |                                                   |                        |                                                                |

### 使用したモック

| モック対象                                   | 内容                                                       |
| -------------------------------------------- | ---------------------------------------------------------- |
| `useAuth`（@/context/AuthContext）           | 認証ユーザー情報（`uid: 'mock-user'`）を返す               |
| `useRouter`（next/navigation）               | `push` 関数を含むルーターのモック                          |
| `useCareSettings`（@/hooks/useCareSettings） | テストごとに `careSettings`, `loading`, `error` を差し替え |
| `useCareLogs`（@/hooks/useCareLogs）         | テストごとに `careLog`, `loading`, `error` を差し替え      |

### ② テスト観点(`Badge` )

- テキストや複数の子要素が正しく表示されるか
- variant（スタイル種別）ごとのスタイルクラスが適用されるか
- カスタムクラスや属性が正しく反映されるか
- 異常値（null/undefined、不正な variant）でもクラッシュせず動作するか
- 実アプリ内でのユースケース（お世話バッジ、優先度、通知数）の表現が正しいか

### テストケース

| テスト ID       | テストケース名                         | 前提条件                          | テスト手順                                           | 期待結果             |
| --------------- | -------------------------------------- | --------------------------------- | ---------------------------------------------------- | -------------------- |
| TC-FE-BADGE-001 | 単一テキストの表示                     | 特になし                          | `<Badge>完了</Badge>` をレンダリング                 | 「完了」が表示される |
| TC-FE-BADGE-002 | 複数の子要素を表示できる               | `<span>`等を含む                  | 複数のテキストが表示される（例：アイコン、テキスト） |                      |
| TC-FE-BADGE-003 | `variant="default"` でクラス適用       | `data-testid="badge"` を指定      | `.bg-primary` クラスが含まれる                       |                      |
| TC-FE-BADGE-004 | `variant="secondary"` のスタイル反映   | -                                 | `.bg-secondary` クラスが適用される                   |                      |
| TC-FE-BADGE-005 | `variant="destructive"` のスタイル反映 | -                                 | `.bg-destructive` クラスが適用される                 |                      |
| TC-FE-BADGE-006 | `variant="outline"` のスタイル反映     | -                                 | `.border` クラスが適用される                         |                      |
| TC-FE-BADGE-007 | カスタムクラスが適用される             | `className="custom-badge"` を指定 | `.custom-badge` クラスが含まれる                     |                      |
| TC-FE-BADGE-008 | カスタム属性が設定される               | `data-status="active"` などを指定 | 属性が反映されていることを確認                       |                      |
| TC-FE-BADGE-009 | 空の子要素でもエラーが出ない           | `<Badge />` を描画                | エラーがスローされないこと                           |                      |
| TC-FE-BADGE-010 | 不正な variant でもエラーが出ない      | `variant="invalid"` を強制指定    | 描画に失敗しないこと                                 |                      |
| TC-FE-BADGE-011 | null/undefined 子要素も描画できる      | `<Badge>{null}</Badge>` 等        | エラーなくレンダリング可能                           |                      |
| TC-FE-BADGE-012 | お世話ステータスのバッジ表示           | 配列マップで描画                  | 完了/未完了の文言が一致する                          |                      |
| TC-FE-BADGE-013 | 緊急度バッジの表示                     | variant による表示制御            | 緊急：destructive、普通：default、低：secondary      |                      |
| TC-FE-BADGE-014 | 通知数バッジの表示                     | 数値をバッジに表示                | `5` が表示される（通知数の反映）                     |                      |

### ③ テスト観点(`Card` UI パーツ群)

- 各 Card パーツが単体で正しく描画されるか
- className や属性のカスタマイズが適用されるか
- 空の要素や構成ミスに対してもクラッシュしないか
- 実使用想定の構成（全パーツ組み合わせ）で正常に動作するか

### テストケース

| テスト ID      | テストケース名                                 | 前提条件                              | テスト手順                                                       | 期待結果                         |
| -------------- | ---------------------------------------------- | ------------------------------------- | ---------------------------------------------------------------- | -------------------------------- |
| TC-FE-CARD-001 | `Card` 単体の表示確認                          | -                                     | `<Card><div>Card content</div></Card>` を描画                    | `Card`が表示され、内容が含まれる |
| TC-FE-CARD-002 | `Card` にクラス名が適用される                  | `className="custom-class"` 指定       | クラスに `custom-class` が含まれる                               |                                  |
| TC-FE-CARD-003 | `CardHeader` にタイトルと説明が表示される      | `CardTitle`, `CardDescription` を内包 | 「タイトル」「説明文」が表示される                               |                                  |
| TC-FE-CARD-004 | `CardContent` に本文が表示される               | `<p>` タグ内にテキストあり            | 「カードの本文」が表示される                                     |                                  |
| TC-FE-CARD-005 | `CardContent` が空でもクラッシュしない         | `<CardContent />` のみ                | エラーが発生しないこと                                           |                                  |
| TC-FE-CARD-006 | `CardFooter` にボタンが表示される              | `<button>` を内包                     | ボタン「アクション」が表示される                                 |                                  |
| TC-FE-CARD-007 | 全ての Card 要素を組み合わせて正しく表示される | Header, Content, Footer を構成        | 「お世話記録」「散歩: 完了」「編集」ボタンなどがすべて表示される |                                  |

### ④ テスト観点(`dateUtils.ts`)

- JST（日本標準時）として適切に処理・変換されているか
- 不正な入力時でも例外をスローせず適切に扱えるか（エラー処理・フォールバック）
- 各フォーマット間の相互変換ロジックが正しいか

### テストケース

| テスト ID      | テストケース名                                                       | 前提条件                    | テスト手順                                           | 期待結果                                     |
| -------------- | -------------------------------------------------------------------- | --------------------------- | ---------------------------------------------------- | -------------------------------------------- |
| TC-FE-DATE-001 | `utcIsoToJstDateString` が正しく JST に変換する                      | UTC 形式の ISO 文字列を渡す | `"2023-01-01T00:00:00Z"` を渡す                      | `"2023-01-01"` を返す（JST: 9 時）           |
| TC-FE-DATE-002 | `jstDateToDateString` が Date→"YYYY-MM-DD"文字列に変換する           | Date オブジェクトを渡す     | `new Date(2023, 4, 5)` を渡す                        | `"2023-05-05"` を返す                        |
| TC-FE-DATE-003 | `dateStringToJstDate` が文字列 →Date 型に変換する                    | `"2023-07-18"` を渡す       | `Date`の年月日を取得                                 | `2023/6/18`（7 月 →6）になる                 |
| TC-FE-DATE-004 | `utcIsoToJstDateString` に不正な日付を渡すと `"Invalid Date"` を返す | `"invalid-date"` を渡す     | 関数の戻り値を検証                                   | `"Invalid Date"` が返る                      |
| TC-FE-DATE-005 | `dateStringToJstDate` に不正文字列を渡しても Date 型になる           | `"invalid-date"` を渡す     | `Date`インスタンスであること・`NaN` を返すことを確認 | `instanceof Date === true`、`isNaN === true` |

### ⑤ テスト観点(`RootLayout`)

- 各プロバイダ（AuthProvider, ThemeProvider, Toaster）が正しく描画されているか
- 子コンポーネントが問題なく描画されるか
- ラップ構造の崩れや描画漏れがないか

### テストケース

| テスト ID        | テストケース名                 | 前提条件             | テスト手順                          | 期待結果                                                                   |
| ---------------- | ------------------------------ | -------------------- | ----------------------------------- | -------------------------------------------------------------------------- |
| TC-FE-LAYOUT-001 | すべてのプロバイダが描画される | 各プロバイダをモック | `<RootLayout>` に子要素を渡して描画 | `auth-provider`, `theme-provider`, `toaster`, 子要素すべてが表示されること |

### 使用したモック

| モック対象                    | 説明                                      |
| ----------------------------- | ----------------------------------------- |
| `@/context/AuthContext`       | `AuthProvider` をテスト用ラッパーでモック |
| `@/components/theme-provider` | `ThemeProvider` を div ラップで代替       |
| `sonner`                      | `Toaster` をダミー要素に置き換え          |

### ⑥ テスト観点(`Progress`)

- value に応じた描画が正しく行われるか
- `className`, `max`  などの属性が正しく適用されるか
- 負値や不正値などの異常入力にも安定して対応できるか
- `role="progressbar"`  や  `aria-*`  属性などアクセシビリティ仕様を満たすか
- 散歩やお世話タスクといった実使用ケースでも正しく動作するか

### テストケース

| テスト ID      | テストケース名         | テスト手順                           | 期待結果                           |
| -------------- | ---------------------- | ------------------------------------ | ---------------------------------- |
| TC-FE-PROG-001 | 進捗値 0% を表示する   | `value={0}` で描画                   | コンポーネントが表示される         |
| TC-FE-PROG-002 | 進捗値 50% を表示する  | `value={50}` で描画                  | `.relative` クラスが含まれる       |
| TC-FE-PROG-003 | 進捗値 100% を表示する | `value={100}` で描画                 | `.relative` クラスが含まれる       |
| TC-FE-PROG-004 | カスタムクラス名の適用 | `className="custom-progress"` を指定 | `custom-progress` が含まれる       |
| TC-FE-PROG-005 | max 属性の反映         | `max={200}` を指定                   | `aria-valuemax="200"` が設定される |

### 異常系・境界値テスト

| テスト ID      | テストケース名       | テスト手順     | 期待結果           |
| -------------- | -------------------- | -------------- | ------------------ |
| TC-FE-PROG-006 | value に負の値を渡す | `value={-10}`  | エラーが発生しない |
| TC-FE-PROG-007 | 100 を超える値を渡す | `value={150}`  | エラーが発生しない |
| TC-FE-PROG-008 | value が未定義       | `value` を省略 | エラーが発生しない |
| TC-FE-PROG-009 | value が null        | `value={null}` | エラーが発生しない |
| TC-FE-PROG-010 | value が文字列       | `value={'50'}` | エラーが発生しない |

### 実用ユースケース

| テスト ID      | テストケース名     | テスト手順                            | 期待結果                        |
| -------------- | ------------------ | ------------------------------------- | ------------------------------- |
| TC-FE-PROG-015 | 散歩の進捗表示     | `value=65` で表示ラベル付き描画       | 「65% 完了」が表示される        |
| TC-FE-PROG-016 | お世話タスクの進捗 | `completed=2`, `total=3` の計算で表示 | 「2/3 完了」「66%」が表示される |

### ⑦ テスト観点(`createReflectionNote`)

- API レスポンスが正常な場合、適切なデータを返却するか
- API が異常終了した場合、例外が正しくスローされるか
- `detail`  のないレスポンスにも適切に対応できるか
- Firebase 認証・環境変数・fetch グローバルの事前設定が有効であるか

### テストケース

| テスト ID         | テストケース名                                   | 前提条件                                             | テスト手順                                  | 期待結果                                                        |
| ----------------- | ------------------------------------------------ | ---------------------------------------------------- | ------------------------------------------- | --------------------------------------------------------------- |
| TC-FE-REFPOST-001 | API が成功した場合にレスポンスを返す             | `fetch` が `ok: true` かつ `message: success` を返す | `createReflectionNote('テスト内容')` を実行 | `message: 'success'` を含むレスポンスが返る                     |
| TC-FE-REFPOST-002 | API がエラーを返した場合に例外が発生する         | `ok: false`, `detail: 'Bad Request'` を返す          | 実行後 `.rejects.toThrow` を確認            | `"Failed to create reflection note"` というエラーがスローされる |
| TC-FE-REFPOST-003 | API が `detail` を返さない場合でも例外が発生する | `ok: false`, `json: {}` を返す                       | 実行後 `.rejects.toThrow` を確認            | 同上のエラーメッセージがスローされる                            |

### 使用したモック

| モック対象                        | 内容                                                                 |
| --------------------------------- | -------------------------------------------------------------------- |
| `@/lib/firebase/config`           | FirebaseApp を空オブジェクトでモック                                 |
| `firebase/auth`                   | `getAuth().currentUser.getIdToken()` をモックし `mock-token` を返す  |
| `fetch`                           | グローバルに `vi.stubGlobal('fetch', fn)` でリクエスト処理を差し替え |
| `process.env.NEXT_PUBLIC_API_URL` | `"<https://example.com>"` に上書き設定                               |

### ⑧ テスト観点(`ReflectionWritingPage`)

- 入力フォームのバリデーション（未入力時のボタン無効など）が正しく機能するか
- 正常な入力でボタンが有効化されるか
- API 送信エラー時にアラート表示でフィードバックが返るか
- Firebase 認証ユーザーが存在する前提で動作するか

### テストケース

| テスト ID         | テストケース名                                   | 前提条件               | テスト手順                                    | 期待結果                                                             |
| ----------------- | ------------------------------------------------ | ---------------------- | --------------------------------------------- | -------------------------------------------------------------------- |
| TC-FE-REFPAGE-001 | 初期状態でボタンが無効である                     | 認証済みユーザーが存在 | ページ描画後、送信ボタンを確認                | `disabled` 属性が付いている                                          |
| TC-FE-REFPAGE-002 | タイトルと反省文を入力するとボタンが有効化される | フォーム両方に入力     | `タイトル`・`はんせいぶん` を入力しボタン確認 | ボタンが有効になる（`enabled`）                                      |
| TC-FE-REFPAGE-003 | API 送信エラー時にアラートが表示される           | API が `reject` を返す | 入力後ボタンをクリックし `alert` を監視       | 「保存に失敗しました。ネットワークを確認してください。」が表示される |

### 使用したモック

| モック対象                    | 内容                                            |
| ----------------------------- | ----------------------------------------------- |
| `@/hooks/reflectionNotesPost` | `default` を `mockCreateReflectionNote` に置換  |
| `next/navigation`             | `useRouter().push` をモック（遷移は未検証）     |
| `@/context/AuthContext`       | `currentUser.uid: 'test-user'` を返す           |
| `global.alert`                | `vi.stubGlobal('alert', alertSpy)` にて置き換え |

### ⑨ テスト観点(`ThemeProvider`)

- テーマ指定やシステムテーマ設定がされている状態で、子要素が正常にレンダリングされるか
- ラッパーとして機能していること（副作用や DOM 制御は対象外）

### テストケース

| テスト ID       | テストケース名           | 前提条件                                           | テスト手順                                                          | 期待結果                                               |
| --------------- | ------------------------ | -------------------------------------------------- | ------------------------------------------------------------------- | ------------------------------------------------------ |
| TC-FE-THEME-001 | 子要素が正常に描画される | `attribute`, `defaultTheme`, `enableSystem` を指定 | `<ThemeProvider>` で `<div>テスト用の子要素</div>` をラップして描画 | `queryByText('テスト用の子要素')` が `null` でないこと |

### ⑩ テスト観点(`Button`)

- ボタン内部の子要素が正しく描画されるか

- `disabled`  属性が有効に機能するか
- `variant` / `size`  に応じてクラス名が適切に変更されるか
- `asChild`  を使ったカスタムタグへの置き換えが正しく機能するか

### テストケース

| テスト ID        | テストケース名                          | テスト手順                              | 期待結果                                       |
| ---------------- | --------------------------------------- | --------------------------------------- | ---------------------------------------------- |
| TC-FE-BUTTON-001 | ボタン内のテキストが表示される          | `<Button>Click me</Button>` を描画      | 「Click me」が表示される                       |
| TC-FE-BUTTON-002 | disabled 属性が有効である               | `<Button disabled>` を描画              | ボタンが `disabled` 状態になる                 |
| TC-FE-BUTTON-003 | variant によって class が変わる         | `variant="destructive"` を指定          | `.bg-destructive` クラスが付与される           |
| TC-FE-BUTTON-004 | size によって class が変わる            | `size="lg"` を指定                      | `.h-11` クラスが付与される                     |
| TC-FE-BUTTON-005 | `asChild`指定時に button タグ以外になる | `<Button asChild><a /></Button>` を描画 | `<a>` タグが生成され、`tagName === "A"` になる |

- フロントエンド単体テスト実行

```bash
npx vitest run
```

- フロントエンド単体テストカバレッジ率実行

```bash
npx vitest run --coverage

```

---

## **テスト対象 2：統合テスト**

## フロントエンド統合テストのテストケース（ファイル名ベース）

| ファイル名                     | 概要                                                                 |
| ------------------------------ | -------------------------------------------------------------------- |
| `admin-basic.test.tsx`         | 管理者ユーザーのログイン・トップページ表示などの基本操作のテスト     |
| `admin-features.test.tsx`      | 管理者権限での機能操作（例：承認ボタン・リスト閲覧など）のテスト     |
| `auth-flow.test.tsx`           | 一般ユーザーのログイン・PIN 認証などの認証フローのテスト             |
| `care-log-flow.test.tsx`       | お世話記録の登録・更新・当日取得といった日常的操作の E2E テスト      |
| `dashboard-full-flow.test.tsx` | ログイン後ダッシュボード表示からメッセージ確認・反省文表示などの流れ |
| `onboarding-flow.test.tsx`     | 初回ログイン後の設定（PIN 設定など）を含むオンボーディング体験の確認 |
| `payment-flow.test.tsx`        | プレミアム決済フロー（Stripe 画面遷移含む）のテスト                  |
| `reflection-features.test.tsx` | 反省文の登録・表示・承認チェックボックスの操作確認など               |
| `walk-flow.test.tsx`           | 散歩記録ページでの記録追加・進捗表示などの機能テスト                 |

---

### フロントエンド統合テストのカバレッジ概要

統合テストでは、下記主要ユースケースに対して Vitest

- 認証・PIN 入力（`auth-flow.test.tsx`）: ✅
- 初期設定（`onboarding-flow.test.tsx`）: ✅
- 記録作成／更新（`care-log-flow.test.tsx`, `walk-flow.test.tsx`）: ✅
- 反省文登録・確認・承認（`reflection-features.test.tsx`）: ✅
- 決済フロー（`payment-flow.test.tsx`）: ✅
- 管理者確認フロー（`admin-basic.test.tsx`, `admin-features.test.tsx`）: ✅

#### 実測カバレッジ（`vitest --coverage` 結果）

| ファイルパス                             | ステートメント | ブランチ | 関数   | 行カバレッジ |
| ---------------------------------------- | -------------- | -------- | ------ | ------------ |
| All files                                | 60.78%         | 68.12%   | 43.62% | 60.78%       |
| `app/page.tsx`                           | 65.38%         | 40.00%   | 100%   | 65.38%       |
| `app/admin/page.tsx`                     | 72.86%         | 36.84%   | 25%    | 72.86%       |
| `app/admin-login/page.tsx`               | 87.17%         | 69.56%   | 100%   | 87.17%       |
| `app/onboarding/first-settings/page.tsx` | 77.21%         | 68.75%   | 22.22% | 77.21%       |
| `app/onboarding/admin-pin/page.tsx`      | 42.55%         | 6.25%    | 14.28% | 42.55%       |
| `app/api/walk_api/walkApi.ts`            | 3.65%          | 100%     | 0%     | 3.65%        |
| `components/ui/select.tsx`               | 89.38%         | 100%     | 100%   | 89.38%       |
| `hooks/useCareLogs.ts`                   | 26.31%         | 50%      | 100%   | 26.31%       |
| `hooks/useCurrentUser.ts`                | 84.31%         | 42.85%   | 100%   | 84.31%       |
| `lib/dateUtils.ts`                       | 100%           | 100%     | 100%   | 100%         |

---

### ⑪E2E テスト：管理者ログインフロー (`admin-auth.e2e.ts`)

- `/admin-login`  ページに正しくアクセスできるか
- 入力フォームに 6 桁のパスワードを入力できるか
- 正しいコードで  `/admin`  ページへリダイレクトされるか
- 不正なコード入力時にエラーメッセージが表示されるか

### テストケース

| テスト ID        | テストケース名                                 | テスト手順                                   | 期待結果                                                       |
| ---------------- | ---------------------------------------------- | -------------------------------------------- | -------------------------------------------------------------- |
| TC-E2E-ADMIN-001 | 管理画面ログインページが表示される             | `/admin-login` にアクセス                    | 「6 桁のログインコードを入力してください」等の UI が表示される |
| TC-E2E-ADMIN-002 | 正しいコードでログインし `/admin` に遷移できる | コード欄に正しい `123456` などを入力し、送信 | `/admin` にリダイレクトされ、管理画面が表示される              |
| TC-E2E-ADMIN-003 | 間違ったコードを入力するとエラー表示           | 不正な `000000` を入力し、送信               | 「コードが間違っています」などのエラーが表示される             |

### 使用モック・前提

| モック        | 内容                                                       |
| ------------- | ---------------------------------------------------------- |
| Firebase Auth | 管理者 UID でのログインセッションまたはモック化済み        |
| API 通信      | `/api/auth/verify-code` 等が正常に動作またはモック済み     |
| ルーティング  | Next.js の `useRouter().push` を確認可能にしている必要あり |

### ⑫E2E テスト：デバッグ UI 検証（`debug-test.e2e.ts`）

- ページアクセスが正常に行えるか
- 「あさごはん」ボタンが表示・有効であるか
- ボタンをクリックすると、完了メッセージが表示されるか

### テストケース

| テスト ID        | テストケース名                     | テスト手順                    | 期待結果                                            |
| ---------------- | ---------------------------------- | ----------------------------- | --------------------------------------------------- |
| TC-E2E-DEBUG-001 | ページタイトルが表示される         | `/debug-test` にアクセス      | 見出し「デバッグテストページ」が表示される          |
| TC-E2E-DEBUG-002 | 「あさごはん」ボタンが表示される   | ページ読み込み後にボタン確認  | `あさごはん` ボタンが表示され、`enabled` 状態である |
| TC-E2E-DEBUG-003 | ボタンクリックで完了メッセージ表示 | `あさごはん` ボタンをクリック | 「🍚 あさごはん完了！」というメッセージが表示される |

### 使用モック・前提

| 項目     | 内容                                                          |
| -------- | ------------------------------------------------------------- |
| 認証     | `TestUserProvider` によるテスト用モックユーザーで包まれている |
| DOM 操作 | `page.getByRole`, `getByText` による UI 確認                  |

### ⑬E2E テスト：オンボーディング画面（`onboarding-welcome.e2e.ts`）

- オンボーディングのウェルカム画面に正常遷移できるか
- 「はじめる」ボタンが表示されているか
- ボタンをクリックすると次のオンボーディング画面へ遷移するか

### テストケース

| テスト ID      | テストケース名                 | テスト手順                       | 期待結果                                                          |
| -------------- | ------------------------------ | -------------------------------- | ----------------------------------------------------------------- |
| TC-E2E-ONB-001 | Welcome ページに遷移できる     | `/onboarding/welcome` にアクセス | ページが読み込まれ、「ようこそ わん 🐾 みっしょんへ」が表示される |
| TC-E2E-ONB-002 | 「はじめる」ボタンが表示される | ページ読み込み後にボタン確認     | `はじめる` ボタンが表示され、`enabled` 状態である                 |
| TC-E2E-ONB-003 | ボタンクリックで次画面に遷移   | 「はじめる」ボタンをクリック     | `/onboarding/character-select` にリダイレクトされる               |

### 使用モック・前提

| 項目         | 内容                                              |
| ------------ | ------------------------------------------------- |
| 認証         | 不要（ゲストアクセス画面）                        |
| DOM 操作     | `page.getByText`, `page.getByRole` による UI 確認 |
| ルーティング | `page.url()` によるパス検証を実施                 |

### テストコマンド(E2E)

- フロントエンド E2E テスト実行（Playwright）

```bash
npx playwright test
```

---

## 考察

✅ 現状の数値
目標：80%
現在：60.78%

目標の 80%に未達です。主な要因は、フロントエンドのテスト必要量の多さ（特にカスタムフックや条件分岐描画）と、一部バックエンド統合処理の例外系カバー漏れにあります。今後は、カバレッジが低い useCareLogs.ts や walkApi.ts の強化、エラー分岐や E2E 検証の追加など、テスト網羅性を高める対応が急務です。低コストな UI パーツのカバレッジ向上も進めつつ、品質と効率の両立を図ります。今後は開発と並行して継続的にテストを拡充し、ユーザー体験の信頼性を高めていきます。
