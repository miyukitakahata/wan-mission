# わん 🐾 みっしょん

[https://github.com/ms-engineer-bc25-04/Section9_TeamC/issues/75](https://github.com/user-attachments/assets/4dda2fcb-8ffa-4529-9185-097a2b21f569)

## プロジェクト概要

犬を迎える前のお世話体験ウェブアプリ「わん 🐾 みっしょん」

「わん 🐾 みっしょん」は、子どもが「犬を飼いたい！」と願う家庭に向けた、**飼う前に体験できる教育アプリ**です。
実際に飼育する前に「お世話の大変さ」「毎日続ける責任」を、親子でスマホから楽しく体験できます。

## 背景・課題

- アンケート調査によると、「子どもにせがまれて」がペットを飼う最大のきっかけ（約 50%）。
- 一方、約 4 割の親が「子どもが世話をしなくなる不安」を抱えている。
- 小学生くらいの子どもは「犬＝かわいい」というイメージが先行し、日々のお世話の大変さを体験する場がない。
- 実際に飼い始めてから親の負担が増え、結果的に手放してしまうケースもある。

## 目的

- 犬を飼いたいと願う子どもが、「毎日のお世話」や「責任の重さ」を事前に体験できる
- 保護者がその様子を見て、本当に飼えるかどうか冷静に判断できる
- 安易な飼育・飼育放棄を減らし、犬も人も幸せになれる未来を目指す

## 機能一覧

- 散歩ミッション機能
  - 毎日 1km の散歩を目標とし、Geolocation API を利用してリアルタイムで歩行距離を表示します。
- お世話の記録
  - ご飯や散歩など、日々のお世話内容を記録できます。
- 反省文機能
  - 1 日のお世話ミッションがすべて実行できなかった場合、翌日に反省文ページが表示されます（お世話の振り返り）。
- 犬の豆知識（有料会員向け）
  - OpenAI API と連携し、子ども向けの豆知識を自動生成します。
- 管理者機能
  - ユーザー情報の管理や決済機能の実行、反省文の閲覧・管理、チャレンジの達成具合などの機能を備えています。
- 認証機能
  - Firebase を利用したユーザー認証を実装しています。
- 決済機能
  - Stripe による一回限りの決済に対応しています。

## 技術構成

| 役割           | 技術・サービス                                                     |
| -------------- | ------------------------------------------------------------------ |
| フロントエンド | Next.js, TypeScript, Tailwind CSS                                  |
| バックエンド   | FastAPI, Python                                                    |
| データベース   | PostgreSQL, Prisma                                                 |
| 外部 API       | OpenAI, Geolocation API                                            |
| 外部サービス   | Firebase（認証）, Stripe（決済）, AWS S3（画像や動画のストレージ） |
| デプロイ       | Vercel, Render                                                     |
| その他         | Adobe Firefly, Figma, GitHub, Docker                               |

## アーキテクチャー図

![アーキテクチャー図](./docs/architecture-diagram.png)

_システム全体の構成と各コンポーネントの関係を示したアーキテクチャー図_

## ディレクトリ構成

```bash
.
├── .github/    # GitHub Actionsなどの設定
├── backend/    # FastAPI バックエンド
├── frontend/   # Next.js フロントエンド
├── docs/       # ドキュメンテーション関連
├── monitoring　# Prometheus・Grafana等の監視設定
├── docker-compose.yml
├── README.md
└── ...
```

## 開発環境のセットアップ

1. リポジトリをクローン

```bash
git clone https://github.com/ms-engineer-bc25-04/Section9_TeamC.git
```

2. データベースのセットアップ

データベースの Docker コンテナを起動します。

```bash
docker-compose up -d
```

backend env ファイル設定例:

```env
DATABASE_URL=postgresql://user:password@localhost:5432/myapp_db
```

3. フロントエンド、バックエンドそれぞれでセットアップ

詳細は各ディレクトリの README 参照

- backend: [backend/README.md](backend/README.md) を参照
- frontend: [frontend/README.md](frontend/README.md) を参照

## コード品質管理

このプロジェクトでは、コードの一貫性と品質を保つために Linter と Formatter を導入しています。

- **フロントエンド**: ESLint (Airbnb) + Prettier
- **バックエンド**: Pylint + Black

詳細な設定と使用方法は各ディレクトリの README を参照してください：

- フロントエンド: [frontend/README.md](frontend/README.md#開発ガイドライン)
- バックエンド: [backend/README.md](backend/README.md#開発ガイドライン)

## 工夫した点・チャレンジポイント

### Geolocation API による歩行距離の正確な測定

- GPS のリアルタイム監視＋ Haversine（ハバーサイン）法で 2 点間距離を正確に算出し、歩行ごとの合計距離を積み上げることで実測に近い記録を実現。
- 位置情報の精度や速度を自動フィルタし、異常値は除外。
- 監視失敗時は定期取得へ自動切り替え。
- 画面にリアルタイムで距離を表示。

### クラウド時代に即した DevOps 体験重視のデプロイ構成

- 初期コストと開発効率を両立するため、フロントエンドは Vercel、バックエンド＆DB は Render を採用。GitHub 連携の自動ビルド・自動デプロイ。
- 画像・動画ストレージには AWS S3 を使用し、バックエンドは Docker で運用。将来的な AWS 等クラウド本格移行も想定した設計。

### AI 活用による知識・応援メッセージの自動生成

- 有料会員には OpenAI API 経由で LLM メッセージ生成（豆知識、応援コメント等）。
- 小学生にも分かりやすい短文・優しい語り口、表現品質を調整。
- 無料ユーザーや API 障害時はプリセットメッセージにフォールバックし、UX の安定性も重視。

## 今後の課題・展望

### リマインダー機能

- 「ごはん」や「散歩」の予定管理、指定時刻に通知・リマインドを行い、生活リズムや責任感を楽しく習慣化。

### お世話計画シミュレーション機能

- 旅行など「不在予定日」をカレンダー登録し、「誰に頼むか？」「ペットホテル？」等、現実的な選択肢や責任を考えさせる体験を拡充。

### 保護犬支援

- Stripe 決済後、LLM 機能が解放される現仕様に加え、今後は決済金額の一部を保護犬団体等に寄付できる仕組みを検討。

## テスト

### 単体テスト

**フロントエンド**

- React コンポーネントの単体テスト（Vitest + Testing Library）
- ユーティリティ関数のテスト
- カスタムフックのテスト
- 正常系・異常系両方のケースをカバー

**バックエンド**

- FastAPI エンドポイントの単体テスト（pytest）
- 正常系・異常系両方のケースをカバー
- モックを使用したルーターレベルのテスト

### 統合テスト

**フロントエンド**

- E2E テスト（Playwright）
- 認証フローの統合テスト
- ユーザージャーニー全体のテスト

**バックエンド**

- データベース統合テスト
- API エンドポイント間の連携テスト
- 外部サービス（Firebase、Stripe）との統合テスト

### テストカバレッジ

**現状**

- バックエンド：93%（目標 80%以上を達成）
- フロントエンド：**約 61%**（Statement Coverage: 60.78%, Branch Coverage: 69.08%, Function Coverage: 43.62%）

**フロントエンドカバレッジの詳細**

現在の良好なカバレッジを達成している領域と改善が必要な領域：

**テスト済み領域（高カバレッジ）:**

- ダッシュボード機能: 統合テストにより主要フローをカバー
- 認証・ユーザー管理: 基本的な認証フローをテスト
- UI コンポーネント: 一部コンポーネントの動作確認

**改善が必要な領域:**

- 管理者機能: テストカバレッジが不十分
- オンボーディング機能: 複雑なフローの一部未テスト
- エラーハンドリング: 異常系のテストケースが少ない
- カスタムフック: Function Coverage が 43.62%と低い

**今後の改善計画**

1. **短期目標（70%到達）**

   - 管理者機能の統合テスト強化（現在進行中）
   - カスタムフックの単体テスト追加で Function Coverage を 60%以上に向上
   - エラーハンドリング系の異常系テスト拡充

2. **中期目標（80%到達）**

   - Playwright による E2E テスト拡張
   - オンボーディングフロー全体の統合テスト完全カバー
   - API 通信層の単体テスト追加

3. **長期目標（85%以上）**
   - 全ページコンポーネントの統合テスト完全カバー
   - パフォーマンステスト・アクセシビリティテストの導入
   - CI/CD パイプラインでのカバレッジ閾値設定

**実行方法**

```bash
# バックエンドテスト
cd backend
source venv/bin/activate
python -m pytest tests --cov=app --cov-report=term-missing

# フロントエンドテスト
cd frontend
npm run test
```

## DevOps

### CI/CD パイプライン

- 自動ビルド、自動デプロイ(Vercel, Render)
- 自動コードフォーマット、Lint、テストの自動化（GitHub Actions）

### 監視・アラート

本プロジェクトでは、サービスの安定運用を目的として、監視・アラート設計を導入しています。

- サーバーの CPU 使用率が高い場合、メールで自動アラート通知
- アプリのレスポンスタイムが遅延した場合、自動で異常検知し通知
- Prometheus UI で各 Exporter の状態やメトリクスをグラフ表示・確認
- アラート通知の動作確認は Postman 等のツールで手軽にテスト可能

監視設計の詳細や運用フローについては、下記ドキュメントをご参照ください。

- [監視・アラート設計書](docs/monitoring_design.md)

- 監視構成図
  ![監視構成図](docs/monitoring_diagram.png)

### キャッシュ・リソース管理

本プロジェクトでは、レスポンス性能の向上と DB 負荷の軽減を目的に、FastAPI に Redis キャッシュを導入しています。

- 頻繁に読み込まれるが、更新頻度が低い API（例：/api/care_logs/list）に対してキャッシュ適用
- クエリパラメータやユーザー ID ごとに 一意のキャッシュキーを設計
- Redis の TTL 設定で 一定時間後に自動削除 → メモリ使用量を適切に管理
- キャッシュ有効時は、DB クエリ数が大幅に減少し、レスポンスタイムが最大 10 分の 1 以下に短縮
- FastAPI Exporter、Redis Exporter、PostgreSQL Exporter を通じて Prometheus にて メトリクス収集 & Grafana で可視化
- Grafana では、CPU 使用率やメモリ負荷、Redis ヒット率などをリアルタイムで監視可能

詳細な設計内容は以下をご参照ください。

- [キャッシュ・リソース管理設計書](docs/redis-cache-resource-design.md)

- システム構成図
  ![システム構成図](docs/redis-cache-architecture.png)

## ライセンス

本プロジェクトは教育目的で作成されています。
